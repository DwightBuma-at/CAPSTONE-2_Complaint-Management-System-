<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Chat ‚Äî CMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#9aa4bf;
      --text:#eaf0ff;
      --brand:#3b82f6;
      --brand-2:#22d3ee;
      --accent:#f59e0b;
      --danger:#ef4444;
      --ok:#10b981;
      --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:18px;
      --border:1px solid rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{
      background:linear-gradient(180deg,#181f36,#0b1020);
      color:var(--text);
      padding:28px 18px 18px 18px;
      position:sticky; top:0; height:100vh;
      box-shadow: 2px 0 18px rgba(0,0,0,.18);
      z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:18px;text-decoration:none;color:var(--text)}
    .shield{width:38px;height:38px;border-radius:12px;background:conic-gradient(from 210deg,var(--brand),var(--brand-2),var(--brand));box-shadow:0 8px 20px rgba(34,211,238,.28)}
    .brand span{font-weight:800;letter-spacing:.2px}
    .badge{display:inline-block;background:rgba(34,211,238,.10);border:1px solid rgba(34,211,238,.18);padding:6px 12px;border-radius:999px;font-weight:700;color:#b7f9ff;margin:6px 0 18px}
    .nav a{
      display:flex;align-items:center;gap:12px;color:var(--muted);text-decoration:none;padding:12px 12px;border-radius:12px;margin:4px 0;font-weight:600;transition:.18s;
    }
    .nav a:hover{background:rgba(34,211,238,.08);color:#fff}
    .nav .active{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#031026;box-shadow:0 2px 8px rgba(34,211,238,.10);}
    .logout{position:absolute;bottom:16px;left:18px;right:18px}
    .logout a{display:flex;gap:8px;align-items:center;color:#fca5a5;text-decoration:none;padding:10px 12px;border-radius:12px;font-weight:700;}
    .logout a:hover{background:rgba(239,68,68,.10);color:#fff}
    .content{padding:32px 36px}
    .top h1{margin:0 0 8px;font-size:clamp(1.4rem,2.2vw,2rem);font-weight:800;letter-spacing:.2px}
    .top .sub{color:var(--muted);margin:0 0 18px 0}
    
    /* Chat Interface Styles */
    .chat-container {
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 600px;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .chat-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(34, 211, 238, 0.2);
      color: #b7f9ff;
    }
    
    .chat-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.25rem;
      flex: 1;
    }
    
    .chat-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .chat-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    
    .chat-list {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .chat-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .chat-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .chat-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-name {
      color: var(--text);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 4px;
    }
    
    .chat-preview {
      color: var(--muted);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-time {
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 500;
      flex-shrink: 0;
    }
    
     /* Sheet styles for chat modal */
     .sheet {
       background: var(--card);
       border: var(--border);
       border-radius: var(--radius);
       box-shadow: var(--shadow);
       display: flex;
       flex-direction: column;
       max-height: 90vh;
       width: 90%;
       max-width: 800px;
     }
     
     .sheet-head {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 20px 24px;
       border-bottom: 1px solid rgba(255, 255, 255, 0.1);
       flex-shrink: 0;
     }
     
     .sheet-body {
       flex: 1;
       padding: 20px 24px;
       overflow: hidden;
     }
    
    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 500px;
      transform: scale(.9);
      transition: transform .3s ease;
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s ease}
    .modal-close:hover{background:rgba(255,255,255,.1);color:var(--text)}
    .confirmation-header{display:flex;align-items:center;gap:16px;padding:24px 24px 20px 24px;border-bottom:none}
    .confirmation-icon{font-size:1.8rem;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(239,68,68,.15);color:var(--danger)}
    .confirmation-header h3{margin:0;color:var(--text);font-size:1.4rem;flex:1;font-weight:700}
    .confirmation-body{padding:0px 24px 24px 24px}
    .confirmation-body p{margin:0;color:var(--muted);font-size:1.1rem;line-height:1.5}
    .confirmation-actions{display:flex;gap:16px;padding:0px 24px 24px 24px;justify-content:flex-end}
    .confirmation-actions .btn{min-width:80px;height:44px;font-weight:700;font-size:1rem}
    @media (max-width:768px){.confirmation-actions{flex-direction:column}.confirmation-actions .btn{width:100%}}
     
     /* Button styles */
     .btn{
       display:inline-flex;align-items:center;gap:8px;justify-content:center;
       height:40px;padding:0 16px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#031026;font-weight:800;cursor:pointer;box-shadow:0 2px 8px rgba(34,211,238,.10);transition:.18s;
     }
     .btn:hover{filter:brightness(1.08)}
     .btn.ghost{background:#181f36;color:var(--text);border:1px solid rgba(255,255,255,.12)}
     .btn.small{height:34px;padding:0 12px;font-size:.92rem}
    
    @media (max-width:980px){
      .layout{grid-template-columns:80px 1fr}
      .brand span,.nav span,.badge{display:none}
      .sidebar{padding:18px 8px}
      .content{padding:18px 6vw}
    }

    /* Notification Modal Styles */
    .notification-content {
      max-width: 450px;
      padding: 0;
    }
   
    .notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 24px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
   
    .notification-icon {
      font-size: 2rem;
      margin-right: 16px;
    }
   
    .notification-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.3rem;
      font-weight: 700;
      flex: 1;
    }
   
    .notification-body {
      padding: 0 24px 20px;
    }
   
    .notification-body p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
      text-align: center;
    }
   
    .notification-actions {
      padding: 0 24px 24px;
    }
   
    .notification-actions .btn {
      margin-top: 0;
    }

    /* Toast Notification Styles */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: var(--border);
      border-radius: var(--radius);
      padding: 12px 20px;
      color: var(--text);
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 10000;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
      word-wrap: break-word;
    }
    
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast.success {
      border-left: 4px solid var(--ok);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
    }
    
    .toast.info {
      border-left: 4px solid var(--brand);
    }

    /* Unread Message Badge Styles */
    .unread-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: linear-gradient(90deg, var(--danger), #dc2626);
      color: white;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-left: 8px;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }

    .chat-name {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    /* Chat delete button styles */
    .chat-delete-btn {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--danger);
      transition: all 0.2s ease;
      opacity: 0.7;
    }

    .chat-delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
      opacity: 1;
      transform: scale(1.1);
    }

    .chat-item:hover .chat-delete-btn {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <a class="brand" href="admin-dashboard.html" aria-label="Admin Home">
        <div class="shield" aria-hidden="true"></div>
        <span>Admin</span>
      </a>
      <div class="badge" id="adminBarangayBadge">Barangay: Loading...</div>
      <nav class="nav">
        <a href="/admin-dashboard.html">üè† <span>Dashboard</span></a>
        <a href="/admin-complaints.html">üßæ <span>Complaints</span></a>
        <a href="/admin-history.html">üìã <span>History</span></a>
        <a href="/admin-user.html">üë• <span>Users</span></a>
        <a href="/admin-chat.html" class="active">üí¨ <span>Message</span></a>
      </nav>
      <div class="logout">
        <a href="#" onclick="logout();return false">‚éã <span>Logout</span></a>
      </div>
    </aside>
    
    <!-- MAIN -->
    <main class="content">
      <div class="top">
        <h1>Admin Chat</h1>
        <p class="sub">Communicate with users and other barangay administrators</p>
      </div>
      
      <!-- Chat Interface -->
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-icon">üí¨</div>
          <h3>Chats</h3>
          <button class="chat-close" onclick="showNotification('Chat interface closed')">&times;</button>
        </div>
         <div class="chat-list" id="chatList">
           <!-- Chat items will be loaded dynamically -->
           <div class="chat-empty-state" id="chatEmptyState" style="display: none;">
             <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
               <div style="font-size: 3rem; margin-bottom: 16px;">üí¨</div>
               <h3 style="margin: 0 0 8px 0; color: var(--text);">No Chats Available</h3>
               <p style="margin: 0; font-size: 0.9rem;">Chat functionality will be available soon.</p>
             </div>
           </div>
         </div>
       </div>
     </main>
   </div>

   <!-- Chat Modal -->
   <div id="chatModal" class="modal hidden">
     <div class="sheet" style="max-width: 800px; height: 80vh;">
       <div class="sheet-head">
         <div style="display: flex; align-items: center; gap: 12px;">
           <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üë§</div>
           <div>
             <strong id="chatUserName">User Name</strong>
             <div style="font-size: 0.9rem; color: var(--muted);">
               <span id="chatUserBarangay">Barangay</span> ‚Ä¢ Complaint #<span id="chatComplaintId">ID</span> ‚Ä¢ <span id="chatComplaintType">Type</span>
             </div>
           </div>
            </div>
         <button class="btn small ghost" onclick="closeChatModal()">Close</button>
          </div>
       <div class="sheet-body" style="display: flex; flex-direction: column; height: calc(100% - 80px);">
         <!-- Chat Messages Area -->
         <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px; border: 1px solid rgba(255,255,255,.1); border-radius: 12px; margin-bottom: 16px; background: rgba(255,255,255,.02);">
           <!-- Messages will be loaded here -->
            </div>

         <!-- Message Input Area -->
         <div style="display: flex; gap: 12px; align-items: flex-end;">
           <div style="flex: 1;">
             <textarea
               id="messageInput"
               placeholder="Type your message here..."
               style="width: 100%; min-height: 60px; max-height: 120px; padding: 12px; border: 1px solid rgba(255,255,255,.1); border-radius: 12px; background: rgba(255,255,255,.05); color: var(--text); resize: vertical; outline: none; font-family: inherit;"
               onkeydown="handleMessageKeydown(event)"
             ></textarea>
          </div>
           <button class="btn" onclick="sendMessage()" id="sendMessageBtn">
             Send
           </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal hidden">
    <div class="modal-content confirmation-content">
      <div class="confirmation-header">
        <div class="confirmation-icon">‚ùì</div>
        <h3 id="confirmationTitle">Logout Confirmation</h3>
        <button class="modal-close" onclick="closeConfirmation()">&times;</button>
      </div>
      <div class="confirmation-body">
        <p id="confirmationMessage">Are you sure you want to logout?</p>
      </div>
      <div class="confirmation-actions">
        <button class="btn ghost" onclick="closeConfirmation()">NO</button>
        <button class="btn" id="confirmYesBtn">YES</button>
      </div>
    </div>
  </div>

<!-- Custom Notification Modal -->
<div id="notificationModal" class="modal hidden">
  <div class="modal-content notification-content">
    <div class="notification-header">
      <div class="notification-icon" id="notificationIcon">‚úÖ</div>
      <h3 id="notificationTitle">Success</h3>
      <button class="modal-close" onclick="closeNotification()">&times;</button>
    </div>
    <div class="notification-body">
      <p id="notificationMessage">Operation completed successfully.</p>
    </div>
    <div class="notification-actions">
      <button class="btn btn--full" onclick="closeNotification()">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Helper functions
    function showNotification(message, type = 'success') {
      const modal = document.getElementById('notificationModal');
      const icon = document.getElementById('notificationIcon');
      const title = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');
     
      // Set content based on type
      if (type === 'success') {
        icon.textContent = '‚úÖ';
        title.textContent = 'Success';
        title.style.color = 'var(--ok)';
      } else if (type === 'error') {
        icon.textContent = '‚ùå';
        title.textContent = 'Error';
        title.style.color = 'var(--danger)';
      } else if (type === 'info') {
        icon.textContent = '‚ÑπÔ∏è';
        title.textContent = 'Information';
        title.style.color = 'var(--brand)';
      }
     
      messageEl.textContent = message;
     
      // Show the notification
      openModal('notificationModal');
    }

    function closeNotification() {
      closeModal('notificationModal');
    }

         // Global variables for chat
     let currentChat = null;
     
     function openChat(conversationId) {
       // Find the chat data
       const chatData = window.chatData.find(chat => chat.conversation_id === conversationId);
       if (!chatData) {
         showNotification('Chat data not found');
         return;
       }
       
       // Set current chat data
       currentChat = {
         conversationId: conversationId,
         complaintId: chatData.complaint_id,
         userName: chatData.user_name,
         userBarangay: chatData.user_barangay,
         complaintType: chatData.complaint_type
       };
       
       // Update chat modal header
       document.getElementById('chatUserName').textContent = currentChat.userName;
       document.getElementById('chatUserBarangay').textContent = currentChat.userBarangay;
       document.getElementById('chatComplaintId').textContent = currentChat.complaintId;
       document.getElementById('chatComplaintType').textContent = currentChat.complaintType;
       
       // Clear previous messages
       document.getElementById('chatMessages').innerHTML = '';
       
       // Load chat messages
       loadChatMessages(currentChat.complaintId);
       
       // Show chat modal
       const modal = document.getElementById('chatModal');
       modal.classList.remove('hidden');
       modal.style.display = 'flex';
       setTimeout(() => modal.classList.add('show'), 10);
       document.body.style.overflow = 'hidden';
       
       // Focus on message input
       setTimeout(() => {
         document.getElementById('messageInput').focus();
       }, 300);
       
       // Refresh chat list to update unread counts
       setTimeout(() => {
         loadChats();
       }, 500);
     }

    // Load chat data dynamically
    async function loadChats() {
      try {
        const response = await fetch('/api/admin/chat/list/');
        const data = await response.json();
        
        if (data.success) {
          if (data.chats && data.chats.length > 0) {
            renderChats(data.chats);
          } else {
            // Show empty state
            document.getElementById('chatEmptyState').style.display = 'block';
          }
        } else {
          throw new Error(data.error || 'Failed to load chats');
        }
        
      } catch (error) {
        console.error('Error loading chats:', error);
        showNotification('Failed to load chats: ' + error.message);
        // Show empty state on error
        document.getElementById('chatEmptyState').style.display = 'block';
      }
    }

         function renderChats(chats) {
       const chatList = document.getElementById('chatList');
       const emptyState = document.getElementById('chatEmptyState');
       
       if (!chats || chats.length === 0) {
         emptyState.style.display = 'block';
         return;
       }
       
       emptyState.style.display = 'none';
       
       // Store chat data globally for access in openChat function
       window.chatData = chats;
       
       // Clear existing chats
       const existingChats = chatList.querySelectorAll('.chat-item');
       existingChats.forEach(chat => chat.remove());
       
       // Render new chats
       chats.forEach(chat => {
         const chatItem = document.createElement('div');
         chatItem.className = 'chat-item';
         chatItem.onclick = () => openChat(chat.conversation_id);
         
         // Format the last activity time
         const lastActivity = formatChatTime(chat.last_activity);
         
         chatItem.innerHTML = `
           <div class="chat-avatar">
             ${chat.user_profile_picture ? 
               `<img src="${chat.user_profile_picture}" alt="User Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : 
               'üë§'
             }
           </div>
           <div class="chat-info">
             <div class="chat-name">
               ${chat.user_name}
               ${chat.unread_count > 0 ? `<span class="unread-badge">${chat.unread_count}</span>` : ''}
             </div>
             <div class="chat-preview">${chat.last_message}</div>
             <div style="font-size: 0.8rem; color: var(--muted); margin-top: 2px;">
               Complaint #${chat.complaint_id} ‚Ä¢ ${chat.complaint_type}
             </div>
           </div>
           <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
             <div class="chat-time">${lastActivity}</div>
             <button class="chat-delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.conversation_id}', '${chat.complaint_id}')" title="Delete Chat">
               üóëÔ∏è
             </button>
           </div>
         `;
         
         chatList.appendChild(chatItem);
       });
     }
    
         function formatChatTime(timestamp) {
       const date = new Date(timestamp);
       const now = new Date();
       const diffInHours = (now - date) / (1000 * 60 * 60);
       
       if (diffInHours < 1) {
         return 'Just now';
       } else if (diffInHours < 24) {
         return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
       } else if (diffInHours < 48) {
         return 'Yesterday';
       } else {
         return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }
     }
     
     // Chat Modal Functions
     function closeChatModal() {
       const modal = document.getElementById('chatModal');
       if (modal) {
         modal.classList.remove('show');
         setTimeout(() => {
           modal.classList.add('hidden');
           modal.style.display = 'none';
           document.body.style.overflow = '';
         }, 300);
         currentChat = null;
       }
     }
     
     async function loadChatMessages(complaintId) {
       try {
         const response = await fetch(`/api/admin/chat/${complaintId}/messages/`);
         const data = await response.json();
         
         if (data.success) {
           if (data.messages && data.messages.length > 0) {
             renderChatMessages(data.messages);
           } else {
             // Show empty state
             const chatMessages = document.getElementById('chatMessages');
             chatMessages.innerHTML = `
               <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                 <div style="font-size: 2rem; margin-bottom: 16px;">üí¨</div>
                 <h3 style="margin: 0 0 8px 0; color: var(--text);">No Messages Yet</h3>
                 <p style="margin: 0; font-size: 0.9rem;">Start a conversation with the user about this complaint.</p>
               </div>
             `;
           }
         } else {
           throw new Error(data.error || 'Failed to load messages');
         }
         
       } catch (error) {
         console.error('Error loading chat messages:', error);
         showNotification('Failed to load chat messages: ' + error.message);
         
         // Show error state
         const chatMessages = document.getElementById('chatMessages');
         chatMessages.innerHTML = `
           <div style="text-align: center; padding: 40px 20px; color: var(--danger);">
             <div style="font-size: 2rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
             <h3 style="margin: 0 0 8px 0; color: var(--text);">Error Loading Messages</h3>
             <p style="margin: 0; font-size: 0.9rem;">Please try again later.</p>
           </div>
         `;
       }
     }
     
     function renderChatMessages(messages) {
       const chatMessages = document.getElementById('chatMessages');
       
       if (!messages || messages.length === 0) {
         chatMessages.innerHTML = `
           <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
             <div style="font-size: 2rem; margin-bottom: 16px;">üí¨</div>
             <h3 style="margin: 0 0 8px 0; color: var(--text);">No Messages Yet</h3>
             <p style="margin: 0; font-size: 0.9rem;">Start a conversation with the user about this complaint.</p>
           </div>
         `;
         return;
       }
       
               chatMessages.innerHTML = messages.map(message => `
          <div style="margin-bottom: 16px; display: flex; ${message.is_admin_message ? 'justify-content: flex-end' : 'justify-content: flex-start'}">
            <div style="max-width: 70%; ${message.is_admin_message ? 'background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #031026;' : 'background: rgba(255,255,255,.15); color: var(--text); border: 1px solid rgba(255,255,255,.1);'} padding: 12px 16px; border-radius: 18px; border-bottom-right-radius: ${message.is_admin_message ? '4px' : '18px'}; border-bottom-left-radius: ${message.is_admin_message ? '18px' : '4px'};">
              <div style="font-size: 0.9rem; margin-bottom: 4px; opacity: 0.8; font-weight: 600;">${message.sender_name}</div>
              <div style="font-size: 1rem; line-height: 1.4;">${message.content}</div>
              <div style="font-size: 0.8rem; margin-top: 4px; opacity: 0.7;">${formatMessageTime(message.timestamp)}</div>
            </div>
          </div>
        `).join('');
       
       // Scroll to bottom
       chatMessages.scrollTop = chatMessages.scrollHeight;
     }
     
     function formatMessageTime(timestamp) {
       const date = new Date(timestamp);
       const now = new Date();
       const diffInHours = (now - date) / (1000 * 60 * 60);
       
       if (diffInHours < 24) {
         return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
       } else {
         return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }
     }
     
     function handleMessageKeydown(event) {
       if (event.key === 'Enter' && !event.shiftKey) {
         event.preventDefault();
         sendMessage();
       }
     }
     
     async function sendMessage() {
       if (!currentChat) {
         showNotification('No active chat session');
         return;
       }
       
       const messageInput = document.getElementById('messageInput');
       const message = messageInput.value.trim();
       
       if (!message) {
         showNotification('Please enter a message');
         return;
       }
       
       const sendBtn = document.getElementById('sendMessageBtn');
       const originalText = sendBtn.textContent;
       
       // Show loading state
       sendBtn.textContent = 'Sending...';
       sendBtn.disabled = true;
       
       try {
         // Send message to backend
         const response = await fetch('/api/admin/chat/send/', {
           method: 'POST',
           headers: { 
             'Content-Type': 'application/json',
             'X-CSRFToken': getCookie('csrftoken')
           },
           body: JSON.stringify({
             complaintId: currentChat.complaintId,
             message: message
           })
         });
         
         const result = await response.json();
         
         if (!result.success) {
           throw new Error(result.error || 'Failed to send message');
         }
         
         // Get admin barangay for sender name
         const adminBarangay = localStorage.getItem('adminBarangay') || 'Admin';
         const senderName = adminBarangay === 'Admin' ? 'Admin' : `${adminBarangay} Admin`;
         
         // Add message to chat
         const chatMessages = document.getElementById('chatMessages');
         const messageDiv = document.createElement('div');
         messageDiv.style.cssText = 'margin-bottom: 16px; display: flex; justify-content: flex-end;';
         messageDiv.innerHTML = `
           <div style="max-width: 70%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #031026; padding: 12px 16px; border-radius: 18px; border-bottom-right-radius: 4px; border-bottom-left-radius: 18px;">
             <div style="font-size: 0.9rem; margin-bottom: 4px; opacity: 0.8;">${senderName}</div>
             <div style="font-size: 1rem; line-height: 1.4;">${message}</div>
             <div style="font-size: 0.8rem; margin-top: 4px; opacity: 0.7;">${formatMessageTime(new Date().toISOString())}</div>
           </div>
         `;
         chatMessages.appendChild(messageDiv);
         
         // Clear input
         messageInput.value = '';
         
         // Scroll to bottom
         chatMessages.scrollTop = chatMessages.scrollHeight;
         
                   // Show success message
          showToast('Message sent successfully!', 'success');
         
         // Refresh chat list to update last message
         setTimeout(() => {
           loadChats();
         }, 1000);
         
       } catch (error) {
         console.error('Error sending message:', error);
         showNotification('Failed to send message: ' + error.message);
       } finally {
         // Reset button state
         sendBtn.textContent = originalText;
         sendBtn.disabled = false;
       }
     }
     
     // Delete chat function
     async function deleteChat(conversationId, complaintId) {
       console.log('üóëÔ∏è Delete chat called:', { conversationId, complaintId });
       
       // Show confirmation dialog
       showConfirmation(
         `Are you sure you want to delete this chat conversation? This action cannot be undone.`,
         'Delete Chat',
         async function() {
           console.log('‚úÖ User confirmed deletion');
           try {
             // Show loading state
             showNotification('Deleting chat...', 'info');
             console.log('üì§ Sending delete request...');
             
             // Send delete request to backend
             const response = await fetch(`/api/admin/chat/${complaintId}/delete/`, {
               method: 'DELETE',
               headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': getCookie('csrftoken')
               },
               body: JSON.stringify({
                 conversationId: conversationId
               })
             });
             
             console.log('üì• Response received:', response.status, response.statusText);
             
             // Check if response is JSON or HTML
             const contentType = response.headers.get('content-type');
             console.log('üìã Content-Type:', contentType);
             
             if (!contentType || !contentType.includes('application/json')) {
               // If it's not JSON, it's likely an HTML error page
               const htmlText = await response.text();
               console.error('‚ùå Server returned HTML instead of JSON:', htmlText.substring(0, 200) + '...');
               throw new Error('Server error: API endpoint not found or server error occurred');
             }
             
             const result = await response.json();
             console.log('üìä Response data:', result);
             
             if (response.ok && result.success) {
               console.log('‚úÖ Delete successful!');
               // Show success message
               showNotification('Chat deleted successfully!', 'success');
               
               // Close chat modal if it's open for this conversation
               if (currentChat && currentChat.conversationId === conversationId) {
                 console.log('üîí Closing open chat modal');
                 closeChatModal();
               }
               
               // Reload chat list to reflect changes
               console.log('üîÑ Reloading chat list...');
               setTimeout(() => {
                 loadChats();
               }, 500);
               
             } else {
               console.error('‚ùå Delete failed:', result);
               console.error('‚ùå Full response details:', {
                 status: response.status,
                 statusText: response.statusText,
                 result: result
               });
               throw new Error(result.error || `Server error: ${response.status} ${response.statusText}`);
             }
             
           } catch (error) {
             console.error('Error deleting chat:', error);
             showNotification('Failed to delete chat: ' + error.message, 'error');
           }
         }
       );
     }

     // CSRF Token helper
     function getCookie(name) {
       let cookieValue = null;
       if (document.cookie && document.cookie !== '') {
         const cookies = document.cookie.split(';');
         for (let i = 0; i < cookies.length; i++) {
           const cookie = cookies[i].trim();
           if (cookie.substring(0, name.length + 1) === (name + '=')) {
             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
             break;
           }
         }
       }
       return cookieValue;
    }

    // Load Admin Barangay
    async function loadAdminBarangay() {
      try {
        // Check if we have cached barangay data
        const cachedBarangay = localStorage.getItem('adminBarangay');
        if (cachedBarangay) {
          document.getElementById('adminBarangayBadge').textContent = `Barangay: ${cachedBarangay}`;
          return; // Use cached data, no need to make API call
        }

        // Get email from localStorage (this is set during login)
        const userData = localStorage.getItem('userData');
        if (!userData) {
          document.getElementById('adminBarangayBadge').textContent = 'Barangay: Not logged in';
          return;
        }

        const adminData = JSON.parse(userData);
        const email = adminData.email;

        if (!email) {
          document.getElementById('adminBarangayBadge').textContent = 'Barangay: Email not found';
          return;
        }

        // Fetch admin data from database
        const response = await fetch('/api/admin/get-data/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success && result.admin_data.barangay) {
            const barangay = result.admin_data.barangay;
            // Cache the barangay data
            localStorage.setItem('adminBarangay', barangay);
            document.getElementById('adminBarangayBadge').textContent = `Barangay: ${barangay}`;
          } else {
            document.getElementById('adminBarangayBadge').textContent = 'Barangay: Unknown';
          }
        } else {
          console.error('Failed to fetch admin data from database');
          document.getElementById('adminBarangayBadge').textContent = 'Barangay: Database Error';
        }
      } catch (error) {
        console.error('Error loading admin barangay from database:', error);
        document.getElementById('adminBarangayBadge').textContent = 'Barangay: Error';
      }
    }

    // Check admin authentication
    async function checkAdminAuth() {
      try {
        const response = await fetch('/api/admin/me/');
        const data = await response.json();
        
        if (!data.authenticated) {
          // Redirect to index with login modal
          window.location.href = '/index.html?show_login=true';
          return;
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Redirect to index with login modal
        window.location.href = '/index.html?show_login=true';
      }
    }

    // Modal Functions
    function openModal(modalId){
      const m=document.getElementById(modalId);
      if(!m)return;
      m.classList.remove('hidden');
      setTimeout(()=>m.classList.add('show'),10);
      document.body.style.overflow='hidden';
    }
    function closeModal(modalId){
      const m=document.getElementById(modalId);
      if(!m)return;
      m.classList.remove('show');
      setTimeout(()=>m.classList.add('hidden'),300);
      document.body.style.overflow='';
    }
    function showConfirmation(message,title='Confirmation',onConfirm){
      document.getElementById('confirmationTitle').textContent=title;
      document.getElementById('confirmationMessage').textContent=message;
      const yesBtn=document.getElementById('confirmYesBtn');
      yesBtn.replaceWith(yesBtn.cloneNode(true));
      document.getElementById('confirmYesBtn').addEventListener('click',function(){
        closeConfirmation();
        if(typeof onConfirm==='function'){onConfirm();}
      });
      openModal('confirmationModal');
    }
    function closeConfirmation(){
      closeModal('confirmationModal');
    }
    function logout(){
      showConfirmation('Are you sure you want to logout?','Logout Confirmation',function(){
        // Clear localStorage
        localStorage.removeItem('userData');
        localStorage.removeItem('adminBarangay'); // Clear cached barangay data
        window.location.href = '/index.html';
      });
    }

         // Add escape key to close chat modal
     document.addEventListener('keydown', function(e) {
       if (e.key === 'Escape') {
         const chatModal = document.getElementById('chatModal');
         if (chatModal && chatModal.classList.contains('show')) {
           closeChatModal();
         }
       }
     });

    // Initialize the page
    function init(){
      loadAdminBarangay();
      // Check if user is authenticated
      checkAdminAuth();
       // Load chat data
       loadChats();
     }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Initialize the page
    init();
  </script>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
</body>
</html>
