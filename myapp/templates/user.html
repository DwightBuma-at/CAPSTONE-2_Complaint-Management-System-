<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Dashboard — CMS</title>




  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">




  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#9aa4bf;
      --text:#eaf0ff;
      --brand:#3b82f6;
      --brand-2:#22d3ee;
      --accent:#f59e0b;
      --ring: rgba(59,130,246,.35);
      --ok:#10b981;
      --danger:#ef4444;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(34,211,238,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(59,130,246,.25), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.6;
    }




    /* Header */
    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter: saturate(160%) blur(8px);
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.50));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 20px}
    .nav__inner{display:flex;align-items:center;justify-content:space-between;height:72px;}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: conic-gradient(from 210deg, var(--brand), var(--brand-2), var(--brand));
      box-shadow: 0 6px 18px rgba(34,211,238,.35);
    }
    .brand span{font-weight:800;letter-spacing:.2px}
    .nav__inner{display:flex;align-items:center;justify-content:space-between}
    .nav__links{display:flex;gap:26px;align-items:center}
    .nav__links a{color:var(--muted);text-decoration:none;font-weight:600}
    .nav__links a:hover{color:#fff}
    .nav__auth{display:flex;gap:12px;align-items:center}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:46px;padding:0 18px;border:none;border-radius:14px;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color:#031026;font-weight:800;cursor:pointer;box-shadow: var(--shadow);
    }
    .btn--ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:#fff}
    .btn--small{height:36px;padding:0 14px;font-size:0.9rem}
         .btn--icon{height:40px;width:40px;padding:0;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:#fff;font-size:1.2rem;transition:all 0.2s ease}
     .btn--icon:hover{background:rgba(255,255,255,.2);transform:scale(1.05)}
     .btn--message{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:#fff;font-size:1rem;font-weight:600;padding:12px 24px;transition:all 0.2s ease}
     .btn--message:hover{background:rgba(255,255,255,.2);transform:scale(1.05)}
    .hamburger{display:none;background:none;border:none;color:#fff;font-size:28px}




    /* Dashboard */
    .dashboard{padding:72px 0 48px}
    .dashboard__header{text-align:center;margin-bottom:48px}
    .welcome{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(34,211,238,.15);color:#b7f9ff;font-weight:700;font-size:.85rem}
    .dashboard h1{font-size:clamp(2rem,5vw,3.5rem);line-height:1.12;margin:.6rem 0}
    .dashboard .lead{color:#c6d0ea;max-width:60ch;margin:0 auto}




    /* User Profile */
    .user-profile{margin-bottom:48px}
    .profile-card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.1);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:32px;
      max-width:500px;
      margin:0 auto;
    }
    .profile-header{
      display:flex;
      align-items:center;
      gap:20px;
    }
    .profile-avatar-container{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .profile-avatar{
      width:80px;
      height:80px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(34,211,238,.3);
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .avatar-edit-btn {
      width: 100%;
      height: 32px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      color: #031026;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
    }
    .avatar-edit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34,211,238,.4);
      background: linear-gradient(135deg, var(--brand-2), var(--brand));
    }
    .avatar-text{
      font-size:2rem;
      color:#031026;
    }
    .profile-info h3{
      margin:0 0 8px 0;
      color:var(--text);
      font-size:1.5rem;
    }
    .profile-info p{
      margin:0 0 12px 0;
      color:var(--muted);
      font-size:1rem;
    }
         .profile-badges{
       display:flex;
       align-items:center;
       gap:12px;
       margin-top:8px;
     }
     .barangay-badge{
       display:inline-block;
       padding:6px 12px;
       background:rgba(34,211,238,.2);
       color:#b7f9ff;
       border:1px solid rgba(34,211,238,.3);
       border-radius:20px;
       font-size:.85rem;
       font-weight:600;
       text-transform:uppercase;
       letter-spacing:0.5px;
     }

    /* Profile Picture Upload Modal */
    .profile-upload-content {
      max-width: 400px;
      padding: 0;
    }
    .profile-upload-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .profile-upload-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(34, 211, 238, 0.2);
      color: #b7f9ff;
    }
    .profile-upload-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.25rem;
      flex: 1;
    }
    .profile-upload-body {
      padding: 20px 24px;
    }
    .profile-upload-body p {
      margin: 0 0 20px 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
    }
    .file-upload-area {
      border: 2px dashed rgba(34, 211, 238, 0.3);
      border-radius: 12px;
      padding: 30px 20px;
      text-align: center;
      background: rgba(34, 211, 238, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }
    .file-upload-area:hover {
      border-color: rgba(34, 211, 238, 0.6);
      background: rgba(34, 211, 238, 0.1);
    }
    .file-upload-area.dragover {
      border-color: var(--brand);
      background: rgba(34, 211, 238, 0.15);
    }
    .file-upload-icon {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--brand);
    }
    .file-upload-text {
      color: var(--text);
      font-weight: 600;
      margin-bottom: 5px;
    }
    .file-upload-hint {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .file-input {
      display: none;
    }
    .preview-container {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    .preview-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--brand);
      margin-bottom: 10px;
    }
    .profile-upload-actions {
      display: flex;
      gap: 12px;
      padding: 16px 24px 24px 24px;
      justify-content: flex-end;
    }
    .profile-upload-actions .btn {
      margin-top: 0;
      min-width: 80px;
    }
    .upload-progress {
      display: none;
      margin-top: 15px;
      text-align: center;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      color: var(--muted);
      font-size: 0.9rem;
    }




    /* Dashboard Grid */
    .dashboard__grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:28px;margin-top:48px}
    .dashboard-card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:32px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .dashboard-card:hover{
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(0,0,0,.45);
    }
    .dashboard-card h3{
      font-size:1.5rem;
      margin:0 0 16px 0;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:12px;
    }
    .dashboard-card p{
      color:var(--muted);
      margin:0 0 24px 0;
      line-height:1.6;
    }
    .dashboard-card .btn{
      width:100%;
      margin-top:16px;
    }




    /* Icons */
    .icon{
      width:24px;
      height:24px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      color:#031026;
      font-weight:bold;
    }




    /* Logout Button */
    .logout-btn{
      background:linear-gradient(90deg, var(--danger), #dc2626);
      color:#fff;
    }




    /* Modal Base Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
   
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
   
    .modal.hidden {
      opacity: 0;
      visibility: hidden;
    }
   
    .modal-content {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 500px;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
   
    .modal.show .modal-content {
      transform: scale(1);
    }
   
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
   
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }




    /* Responsive */
    @media (max-width:768px){
      .dashboard__grid{grid-template-columns:1fr;gap:20px}
      .dashboard-card{padding:24px}
      .nav__links{display:none}
      .hamburger{display:block}
      .profile-card{padding:24px}
      .profile-header{flex-direction:column;text-align:center;gap:16px}
      .profile-avatar{width:70px;height:70px}
      .avatar-text{font-size:1.5rem}
      .profile-upload-actions {
        flex-direction: column;
      }
      .profile-upload-actions .btn {
        width: 100%;
      }
    }




    /* Notification Modal Styles */
    .notification-content {
      max-width: 450px;
      padding: 0;
    }
   
    .notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 24px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
   
    .notification-icon {
      font-size: 2rem;
      margin-right: 16px;
    }
   
    .notification-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.3rem;
      font-weight: 700;
      flex: 1;
    }
   
    .notification-body {
      padding: 0 24px 20px;
    }
   
    .notification-body p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
      text-align: center;
    }
   
    .notification-actions {
      padding: 0 24px 24px;
    }
   
    .notification-actions .btn {
      margin-top: 0;
    }




    /* Confirmation Modal Styles */
    .confirmation-content {
      max-width: 450px;
      padding: 0;
    }
   
    .confirmation-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 24px 24px 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
   
    .confirmation-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(34, 211, 238, 0.2);
      color: #b7f9ff;
    }
   
    .confirmation-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.25rem;
      flex: 1;
    }
   
    .confirmation-body {
      padding: 20px 24px;
    }
   
    .confirmation-body p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
    }
   
    .confirmation-actions {
      display: flex;
      gap: 12px;
      padding: 16px 24px 24px 24px;
      justify-content: flex-end;
    }
   
    .confirmation-actions .btn {
      margin-top: 0;
      min-width: 80px;
    }
   
         @media (max-width: 768px) {
       .confirmation-actions {
         flex-direction: column;
       }
      
       .confirmation-actions .btn {
         width: 100%;
       }
     }

     /* Messages Modal Styles */
     .messages-content {
       max-width: 500px;
       padding: 0;
     }
    
     .messages-header {
       display: flex;
       align-items: center;
       gap: 16px;
       padding: 24px 24px 16px 24px;
       border-bottom: 1px solid rgba(255, 255, 255, 0.1);
     }
    
     .messages-icon {
       font-size: 1.5rem;
       width: 40px;
       height: 40px;
       display: flex;
       align-items: center;
       justify-content: center;
       border-radius: 50%;
       background: rgba(34, 211, 238, 0.2);
       color: #b7f9ff;
     }
    
     .messages-header h3 {
       margin: 0;
       color: var(--text);
       font-size: 1.25rem;
       flex: 1;
     }
    
     .messages-body {
       padding: 0;
     }
    
     .messages-list {
       max-height: 400px;
       overflow-y: auto;
     }
    
     .message-item {
       display: flex;
       align-items: center;
       gap: 16px;
       padding: 16px 24px;
       cursor: pointer;
       transition: all 0.2s ease;
       border-bottom: 1px solid rgba(255, 255, 255, 0.05);
     }
    
     .message-item:hover {
       background: rgba(255, 255, 255, 0.05);
     }
    
     .message-avatar {
       width: 48px;
       height: 48px;
       border-radius: 50%;
       background: linear-gradient(135deg, var(--brand), var(--brand-2));
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 1.5rem;
       flex-shrink: 0;
     }
    
     .message-info {
       flex: 1;
       min-width: 0;
     }
    
     .message-name {
       color: var(--text);
       font-weight: 600;
       font-size: 1rem;
       margin-bottom: 4px;
     }
    
     .message-preview {
       color: var(--muted);
       font-size: 0.9rem;
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
     }
    
     .message-time {
       color: var(--muted);
       font-size: 0.8rem;
       font-weight: 500;
       flex-shrink: 0;
     }

     /* Sheet styles for chat modal */
     .sheet {
       background: var(--card);
       border: var(--border);
       border-radius: var(--radius);
       box-shadow: var(--shadow);
       display: flex;
       flex-direction: column;
       max-height: 90vh;
       width: 90%;
       max-width: 800px;
     }
     
     .sheet-head {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 20px 24px;
       border-bottom: 1px solid rgba(255, 255, 255, 0.1);
       flex-shrink: 0;
     }
     
          .sheet-body {
       flex: 1;
       padding: 20px 24px;
       overflow: hidden;
     }

     /* Toast Notification Styles */
     .toast {
       position: fixed;
       top: 20px;
       right: 20px;
       background: var(--card);
       border: 1px solid rgba(255, 255, 255, 0.1);
       border-radius: var(--radius);
       padding: 12px 20px;
       color: var(--text);
       font-weight: 600;
       box-shadow: var(--shadow);
       z-index: 10000;
       transform: translateX(100%);
       opacity: 0;
       transition: all 0.3s ease;
       max-width: 300px;
       word-wrap: break-word;
     }
     
     .toast.show {
       transform: translateX(0);
       opacity: 1;
     }
     
     .toast.success {
       border-left: 4px solid var(--ok);
     }
     
     .toast.error {
       border-left: 4px solid var(--danger);
     }
     
     .toast.info {
       border-left: 4px solid var(--brand);
     }

     /* Unread Message Badge Styles */
     .unread-badge {
       display: inline-flex;
       align-items: center;
       justify-content: center;
       min-width: 20px;
       height: 20px;
       padding: 0 6px;
       background: linear-gradient(90deg, var(--danger), #dc2626);
       color: white;
       border-radius: 10px;
       font-size: 0.75rem;
       font-weight: 700;
       margin-left: 8px;
       box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
     }

     .chat-name {
       display: flex;
       align-items: center;
       font-weight: 600;
       font-size: 1rem;
       margin-bottom: 4px;
     }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="nav">
    <div class="wrap">
      <nav class="nav__inner">
        <a href="#" class="brand" onclick="return false;">
          <div class="logo"></div>
          <span>CMS</span>
        </a>
        <div class="nav__auth">
          <button class="btn logout-btn btn--small" onclick="logout()">Logout</button>
        </div>
      </nav>
    </div>
  </header>




  <!-- Dashboard -->
  <main class="dashboard">
    <div class="wrap">
      <div class="dashboard__header">
        <span class="welcome">Welcome Back!</span>
        <h1>User Dashboard</h1>
        <p class="lead">Manage your complaints and track their progress</p>
      </div>




             <!-- User Profile Section -->
       <div class="user-profile">
         <div style="display: flex; align-items: flex-start; gap: 20px; max-width: 700px; margin: 0 auto;">
           <div class="profile-card">
                        <div class="profile-header">
                <div class="profile-avatar-container">
                  <div class="profile-avatar" onclick="openProfileUploadModal()">
                    <img src="" alt="Profile Picture" id="profilePicture" style="display: none;">
                    <span class="avatar-text" id="avatarText">👤</span>
                  </div>
                  <button class="avatar-edit-btn" onclick="openProfileUploadModal()">
                    Edit
                  </button>
                </div>
                            <div class="profile-info">
                  <h3 id="userFullName">User Name</h3>
                  <p id="userEmail">user@email.com</p>
                  <div class="profile-badges">
                    <span class="barangay-badge" id="userBarangay">Barangay</span>
                  </div>
                </div>
             </div>
          </div>
         </div>
       </div>

       <!-- Message Button positioned exactly where the white line indicates -->
       <div style="text-align: center; margin: 32px 0;">
         <button class="btn btn--message" onclick="showMessageNotification()">Message</button>
       </div>

      <div class="dashboard__grid">
        <!-- Submit Complaint Card -->
        <div class="dashboard-card">
          <h3>
            <span class="icon">📝</span>
            Submit a Complaint
          </h3>
          <p>Report an issue or submit a new complaint. We'll process it and keep you updated on the progress.</p>
          <button class="btn" onclick="openComplaintForm()">Submit Complaint</button>
        </div>




        <!-- View Transaction Card -->
        <div class="dashboard-card">
          <h3>
            <span class="icon">👁️</span>
            View Transaction
          </h3>
          <p>Track the progress of your submitted complaints. See current status and updates in real-time.</p>
          <button class="btn" onclick="window.location.href='user-view.html'">View Progress</button>
        </div>




        <!-- Transaction History Card -->
        <div class="dashboard-card">
          <h3>
            <span class="icon">📊</span>
            Transaction History
          </h3>
          <p>View completed transactions and resolved complaints. Access your full complaint history.</p>
          <button class="btn" onclick="viewHistory()">View History</button>
        </div>
      </div>
    </div>
  </main>




  <!-- Custom Notification Modal -->
  <div id="notificationModal" class="modal hidden">
    <div class="modal-content notification-content">
      <div class="notification-header">
        <div class="notification-icon" id="notificationIcon">✅</div>
        <h3 id="notificationTitle">Success</h3>
        <button class="modal-close" onclick="closeNotification()">&times;</button>
      </div>
      <div class="notification-body">
        <p id="notificationMessage">Operation completed successfully.</p>
      </div>
      <div class="notification-actions">
        <button class="btn btn--full" onclick="closeNotification()">OK</button>
      </div>
    </div>
  </div>




  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal hidden">
    <div class="modal-content confirmation-content">
      <div class="confirmation-header">
        <div class="confirmation-icon" id="confirmationIcon">❓</div>
        <h3 id="confirmationTitle">Confirmation</h3>
        <button class="modal-close" onclick="closeConfirmation()">&times;</button>
      </div>
      <div class="confirmation-body">
        <p id="confirmationMessage">Are you sure you want to proceed?</p>
      </div>
      <div class="confirmation-actions">
        <button class="btn btn--ghost" onclick="closeConfirmation()">NO</button>
        <button class="btn" id="confirmYesBtn">YES</button>
      </div>
    </div>
  </div>




     <!-- Messages Modal -->
   <div id="messagesModal" class="modal hidden">
     <div class="modal-content messages-content">
       <div class="messages-header">
         <div class="messages-icon">💬</div>
         <h3>Chats</h3>
         <button class="modal-close" onclick="closeMessagesModal()">&times;</button>
       </div>
       <div class="messages-body">
         <div class="messages-list" id="userChatList">
           <!-- Chat items will be loaded dynamically -->
           <div class="chat-empty-state" id="chatEmptyState" style="display: none;">
             <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
               <div style="font-size: 3rem; margin-bottom: 16px;">💬</div>
               <h3 style="margin: 0 0 8px 0; color: var(--text);">No Chats Available</h3>
               <p style="margin: 0; font-size: 0.9rem;">Chat with admins will appear here when they message you about your complaints.</p>
             </div>
           </div>
             </div>
           </div>
             </div>
           </div>

   <!-- User Chat Modal -->
   <div id="userChatModal" class="modal hidden">
     <div class="sheet" style="max-width: 800px; height: 80vh;">
       <div class="sheet-head">
         <div style="display: flex; align-items: center; gap: 12px;">
           <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">👤</div>
           <div>
             <strong id="chatAdminName" style="color: var(--text); font-size: 1.1rem;">Admin Name</strong>
             <div style="font-size: 0.9rem; color: var(--muted); margin-top: 2px;">
               Complaint #<span id="chatComplaintId">ID</span> • <span id="chatComplaintType">Type</span>
             </div>
           </div>
         </div>
         <button class="btn small ghost" onclick="closeUserChatModal()">Close</button>
       </div>
       <div class="sheet-body" style="display: flex; flex-direction: column; height: calc(100% - 80px);">
         <!-- Chat Messages Area -->
         <div id="userChatMessages" style="flex: 1; overflow-y: auto; padding: 16px; border: 1px solid rgba(255,255,255,.1); border-radius: 12px; margin-bottom: 16px; background: rgba(255,255,255,.02);">
           <!-- Messages will be loaded here -->
         </div>

         <!-- Message Input Area -->
         <div style="display: flex; gap: 12px; align-items: flex-end;">
           <div style="flex: 1;">
             <textarea
               id="userMessageInput"
               placeholder="Type your message here..."
               style="width: 100%; min-height: 60px; max-height: 120px; padding: 12px; border: 1px solid rgba(255,255,255,.1); border-radius: 12px; background: rgba(255,255,255,.05); color: var(--text); resize: vertical; outline: none; font-family: inherit;"
               onkeydown="handleUserMessageKeydown(event)"
             ></textarea>
           </div>
           <button class="btn" onclick="sendUserMessage()" id="sendUserMessageBtn">
             Send
           </button>
         </div>
       </div>
     </div>
   </div>

   <!-- Profile Picture Upload Modal -->
   <div id="profileUploadModal" class="modal hidden">
     <div class="modal-content profile-upload-content">
       <div class="profile-upload-header">
         <div class="profile-upload-icon">🖼️</div>
         <h3>Change Profile Picture</h3>
         <button class="modal-close" onclick="closeProfileUploadModal()">&times;</button>
       </div>
       <div class="profile-upload-body">
         <p>Click the area above to select a new profile picture, or drag and drop a file.</p>
         <div class="file-upload-area" id="dropZone">
           <input type="file" id="fileInput" class="file-input" accept="image/*">
           <div class="file-upload-icon">📁</div>
           <div class="file-upload-text">Click to browse or drag & drop</div>
           <div class="file-upload-hint">PNG, JPG, GIF up to 5MB</div>
         </div>
         <div class="preview-container" id="previewContainer">
           <img src="https://via.placeholder.com/100" alt="Profile Preview" class="preview-image">
           <p class="file-upload-text">No file selected</p>
         </div>
         <div class="upload-progress">
           <div class="progress-bar">
             <div class="progress-fill" id="uploadProgressFill"></div>
           </div>
           <div class="progress-text">Uploading...</div>
         </div>
       </div>
       <div class="profile-upload-actions">
         <button class="btn btn--ghost" onclick="closeProfileUploadModal()">Cancel</button>
         <button class="btn" id="uploadProfileBtn">Upload</button>
       </div>
     </div>
   </div>




  <script>
    // Modal Functions
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        // Use setTimeout to ensure the modal is visible before adding the show class
        setTimeout(() => {
          modal.classList.add('show');
        }, 10);
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }
    }




    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 300);
        document.body.style.overflow = ''; // Restore scrolling
      }
    }




    // Notification Modal Functions
    function showNotification(message, type = 'success') {
      const modal = document.getElementById('notificationModal');
      const icon = document.getElementById('notificationIcon');
      const title = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');
     
      // Set content based on type
      if (type === 'success') {
        icon.textContent = '✅';
        title.textContent = 'Success';
        title.style.color = 'var(--ok)';
      } else if (type === 'error') {
        icon.textContent = '❌';
        title.textContent = 'Error';
        title.style.color = 'var(--danger)';
      } else if (type === 'info') {
        icon.textContent = 'ℹ️';
        title.textContent = 'Information';
        title.style.color = 'var(--brand)';
      }
     
      messageEl.textContent = message;
     
      // Show the notification
      openModal('notificationModal');
    }
   
    function closeNotification() {
      closeModal('notificationModal');
    }

         // Message notification function
     function showMessageNotification() {
       openModal('messagesModal');
     }

     // Messages Modal Functions
     function closeMessagesModal() {
       closeModal('messagesModal');
     }

     // Global variables for user chat
     let currentUserChat = null;
     let userChatData = [];

     // Load user chat data dynamically
     async function loadUserChats() {
       try {
         const response = await fetch('/api/user/chat/list/');
         const data = await response.json();
         
         if (response.status === 401) {
           // User is not authenticated, redirect to login
           window.location.href = '/index.html?show_login=true';
           return;
         }
         
         if (data.success) {
           if (data.chats && data.chats.length > 0) {
             userChatData = data.chats;
             renderUserChats(data.chats);
           } else {
             // Show empty state
             document.getElementById('chatEmptyState').style.display = 'block';
           }
         } else {
           throw new Error(data.error || 'Failed to load chats');
         }
         
       } catch (error) {
         console.error('Error loading user chats:', error);
         // Don't show error notification for authentication issues
         if (!error.message.includes('Authentication required')) {
           showNotification('Failed to load chats: ' + error.message);
         }
         // Show empty state on error
         document.getElementById('chatEmptyState').style.display = 'block';
       }
     }

     function renderUserChats(chats) {
       const chatList = document.getElementById('userChatList');
       const emptyState = document.getElementById('chatEmptyState');
       
       if (!chats || chats.length === 0) {
         emptyState.style.display = 'block';
         return;
       }
       
       emptyState.style.display = 'none';
       
       // Clear existing chats
       const existingChats = chatList.querySelectorAll('.message-item');
       existingChats.forEach(chat => chat.remove());
       
       // Render new chats
       chats.forEach(chat => {
         const chatItem = document.createElement('div');
         chatItem.className = 'message-item';
         chatItem.onclick = () => openUserChat(chat.conversation_id);
         
         // Format the last activity time
         const lastActivity = formatChatTime(chat.last_activity);
         
         chatItem.innerHTML = `
           <div class="message-avatar">🏘️</div>
           <div class="message-info">
             <div class="message-name">
               ${chat.admin_name}
               ${chat.unread_count > 0 ? `<span class="unread-badge">${chat.unread_count}</span>` : ''}
             </div>
             <div class="message-preview">${chat.last_message}</div>
             <div style="font-size: 0.8rem; color: var(--muted); margin-top: 2px;">
               Complaint #${chat.complaint_id} • ${chat.complaint_type}
             </div>
           </div>
           <div class="message-time">${lastActivity}</div>
         `;
         
         chatList.appendChild(chatItem);
       });
     }

     function formatChatTime(timestamp) {
       const date = new Date(timestamp);
       const now = new Date();
       const diffInHours = (now - date) / (1000 * 60 * 60);
       
       if (diffInHours < 1) {
         return 'Just now';
       } else if (diffInHours < 24) {
         return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
       } else if (diffInHours < 48) {
         return 'Yesterday';
       } else {
         return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }
     }

     function openUserChat(conversationId) {
       // Find the chat data
       const chatData = userChatData.find(chat => chat.conversation_id === conversationId);
       if (!chatData) {
         showNotification('Chat data not found');
         return;
       }
       
       // Set current chat data
       currentUserChat = {
         conversationId: conversationId,
         complaintId: chatData.complaint_id,
         adminName: chatData.admin_name,
         complaintType: chatData.complaint_type
       };
       
       // Update chat modal header
       document.getElementById('chatAdminName').textContent = currentUserChat.adminName;
       document.getElementById('chatComplaintId').textContent = currentUserChat.complaintId;
       document.getElementById('chatComplaintType').textContent = currentUserChat.complaintType;
       
       // Clear previous messages
       document.getElementById('userChatMessages').innerHTML = '';
       
       // Load chat messages
       loadUserChatMessages(currentUserChat.complaintId);
       
       // Close messages modal and open chat modal
       closeMessagesModal();
       openModal('userChatModal');
       
       // Focus on message input
       setTimeout(() => {
         document.getElementById('userMessageInput').focus();
       }, 300);
       
       // Refresh chat list to update unread counts
       setTimeout(() => {
         loadUserChats();
       }, 500);
     }

     function closeUserChatModal() {
       closeModal('userChatModal');
       currentUserChat = null;
     }

     async function loadUserChatMessages(complaintId) {
       try {
         const response = await fetch(`/api/user/chat/${complaintId}/messages/`);
         const data = await response.json();
         
         if (response.status === 401) {
           // User is not authenticated, redirect to login
           window.location.href = '/index.html?show_login=true';
           return;
         }
         
         if (data.success) {
           if (data.messages && data.messages.length > 0) {
             renderUserChatMessages(data.messages);
           } else {
             // Show empty state
             const chatMessages = document.getElementById('userChatMessages');
             chatMessages.innerHTML = `
               <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                 <div style="font-size: 2rem; margin-bottom: 16px;">💬</div>
                 <h3 style="margin: 0 0 8px 0; color: var(--text);">No Messages Yet</h3>
                 <p style="margin: 0; font-size: 0.9rem;">Start a conversation with the admin about this complaint.</p>
               </div>
             `;
           }
         } else {
           throw new Error(data.error || 'Failed to load messages');
         }
         
       } catch (error) {
         console.error('Error loading user chat messages:', error);
         // Don't show error notification for authentication issues
         if (!error.message.includes('Authentication required')) {
           showNotification('Failed to load chat messages: ' + error.message);
         }
         
         // Show error state
         const chatMessages = document.getElementById('userChatMessages');
         chatMessages.innerHTML = `
           <div style="text-align: center; padding: 40px 20px; color: var(--danger);">
             <div style="font-size: 2rem; margin-bottom: 16px;">⚠️</div>
             <h3 style="margin: 0 0 8px 0; color: var(--text);">Error Loading Messages</h3>
             <p style="margin: 0; font-size: 0.9rem;">Please try again later.</p>
           </div>
         `;
       }
     }

     function renderUserChatMessages(messages) {
       const chatMessages = document.getElementById('userChatMessages');
       
       if (!messages || messages.length === 0) {
         chatMessages.innerHTML = `
           <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
             <div style="font-size: 2rem; margin-bottom: 16px;">💬</div>
             <h3 style="margin: 0 0 8px 0; color: var(--text);">No Messages Yet</h3>
             <p style="margin: 0; font-size: 0.9rem;">Start a conversation with the admin about this complaint.</p>
           </div>
         `;
         return;
       }
       
       chatMessages.innerHTML = messages.map(message => `
         <div style="margin-bottom: 16px; display: flex; ${message.is_admin_message ? 'justify-content: flex-start' : 'justify-content: flex-end'}">
           <div style="max-width: 70%; ${message.is_admin_message ? 'background: rgba(255,255,255,.15); color: var(--text); border: 1px solid rgba(255,255,255,.1);' : 'background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #031026;'} padding: 12px 16px; border-radius: 18px; border-bottom-right-radius: ${message.is_admin_message ? '18px' : '4px'}; border-bottom-left-radius: ${message.is_admin_message ? '4px' : '18px'};">
             <div style="font-size: 0.9rem; margin-bottom: 4px; opacity: 0.8; font-weight: 600;">${message.sender_name}</div>
             <div style="font-size: 1rem; line-height: 1.4;">${message.content}</div>
             <div style="font-size: 0.8rem; margin-top: 4px; opacity: 0.7;">${formatMessageTime(message.timestamp)}</div>
           </div>
         </div>
       `).join('');
       
       // Scroll to bottom
       chatMessages.scrollTop = chatMessages.scrollHeight;
     }

     function formatMessageTime(timestamp) {
       const date = new Date(timestamp);
       const now = new Date();
       const diffInHours = (now - date) / (1000 * 60 * 60);
       
       if (diffInHours < 24) {
         return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
       } else {
         return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }
     }

     function handleUserMessageKeydown(event) {
       if (event.key === 'Enter' && !event.shiftKey) {
         event.preventDefault();
         sendUserMessage();
       }
     }

     async function sendUserMessage() {
       if (!currentUserChat) {
         showNotification('No active chat session');
         return;
       }
       
       const messageInput = document.getElementById('userMessageInput');
       const message = messageInput.value.trim();
       
       if (!message) {
         showNotification('Please enter a message');
         return;
       }
       
       const sendBtn = document.getElementById('sendUserMessageBtn');
       const originalText = sendBtn.textContent;
       
       // Show loading state
       sendBtn.textContent = 'Sending...';
       sendBtn.disabled = true;
       
       try {
         // Send message to backend
         const response = await fetch('/api/user/chat/send/', {
           method: 'POST',
           headers: { 
             'Content-Type': 'application/json',
             'X-CSRFToken': getCookie('csrftoken')
           },
           body: JSON.stringify({
             complaintId: currentUserChat.complaintId,
             message: message
           })
         });
         
         const result = await response.json();
         
         if (!result.success) {
           throw new Error(result.error || 'Failed to send message');
         }
         
         // Add message to chat
         const chatMessages = document.getElementById('userChatMessages');
         const messageDiv = document.createElement('div');
         messageDiv.style.cssText = 'margin-bottom: 16px; display: flex; justify-content: flex-end;';
         messageDiv.innerHTML = `
           <div style="max-width: 70%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #031026; padding: 12px 16px; border-radius: 18px; border-bottom-right-radius: 4px; border-bottom-left-radius: 18px;">
             <div style="font-size: 0.9rem; margin-bottom: 4px; opacity: 0.8;">You</div>
             <div style="font-size: 1rem; line-height: 1.4;">${message}</div>
             <div style="font-size: 0.8rem; margin-top: 4px; opacity: 0.7;">${formatMessageTime(new Date().toISOString())}</div>
           </div>
         `;
         chatMessages.appendChild(messageDiv);
         
         // Clear input
         messageInput.value = '';
         
         // Scroll to bottom
         chatMessages.scrollTop = chatMessages.scrollHeight;
         
         // Show success message
         showToast('Message sent successfully!', 'success');
         
         // Refresh chat list to update last message
         setTimeout(() => {
           loadUserChats();
         }, 1000);
         
       } catch (error) {
         console.error('Error sending message:', error);
         showNotification('Failed to send message: ' + error.message);
       } finally {
         // Reset button state
         sendBtn.textContent = originalText;
         sendBtn.disabled = false;
       }
     }




    // Confirmation Modal Functions
    function showConfirmation(message, title = 'Confirmation', onConfirm) {
      const modal = document.getElementById('confirmationModal');
      const titleEl = document.getElementById('confirmationTitle');
      const messageEl = document.getElementById('confirmationMessage');
      const yesBtn = document.getElementById('confirmYesBtn');
     
      // Set content
      titleEl.textContent = title;
      messageEl.textContent = message;
     
      // Remove any existing event listeners
      yesBtn.replaceWith(yesBtn.cloneNode(true));
     
      // Get the new button reference
      const newYesBtn = document.getElementById('confirmYesBtn');
     
      // Add event listener for confirmation
      newYesBtn.addEventListener('click', function() {
        closeConfirmation();
        if (onConfirm && typeof onConfirm === 'function') {
          onConfirm();
        }
      });
     
      // Show the confirmation modal
      openModal('confirmationModal');
    }
   
    function closeConfirmation() {
      closeModal('confirmationModal');
    }




    // Logout function
    function logout() {
      showConfirmation('Are you sure you want to logout?', 'Logout Confirmation', function() {
        // User confirmed logout
        // Don't clear localStorage completely - keep profile picture data
        // Just clear sensitive data but keep the profile picture
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const profilePicture = userData.profile_picture; // Save profile picture
        
        // Clear localStorage but preserve profile picture
        localStorage.clear();
        
        // Restore profile picture for next login
        if (profilePicture) {
          localStorage.setItem('temp_profile_picture', profilePicture);
        }
        
        window.location.href = 'index.html';
      });
    }




    // Submit Complaint function
    function openComplaintForm() {
      // Redirect to the complaint form page
      window.location.href = 'user-submit.html';
    }




    // View Transactions function
    function viewTransactions() {
      showNotification('Transaction progress will be displayed here. This feature is coming soon!', 'info');
      // TODO: Implement transaction progress view
    }




    // View History function
    function viewHistory() {
      window.location.href = 'user-history.html';
    }




    // Profile Picture Upload Modal Functions
    function openProfileUploadModal() {
      openModal('profileUploadModal');
      // Add event listeners
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('dropZone').addEventListener('click', () => document.getElementById('fileInput').click());
      document.getElementById('dropZone').addEventListener('dragover', handleDragOver);
      document.getElementById('dropZone').addEventListener('dragleave', handleDragLeave);
      document.getElementById('dropZone').addEventListener('drop', handleDrop);
      document.getElementById('uploadProfileBtn').addEventListener('click', uploadProfilePicture);
    }

    function closeProfileUploadModal() {
      closeModal('profileUploadModal');
      // Reset the form
      document.getElementById('fileInput').value = ''; // Clear file input
      document.getElementById('previewContainer').style.display = 'none';
      document.getElementById('uploadProgressFill').style.width = '0%';
      document.querySelector('.progress-text').textContent = 'Uploading...';
      document.querySelector('.upload-progress').style.display = 'none';
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        previewFile(file);
      }
    }

    function handleDragOver(event) {
      event.preventDefault();
      document.getElementById('dropZone').classList.add('dragover');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      document.getElementById('dropZone').classList.remove('dragover');
    }

    function handleDrop(event) {
      event.preventDefault();
      document.getElementById('dropZone').classList.remove('dragover');
      const file = event.dataTransfer.files[0];
      if (file) {
        previewFile(file);
      }
    }

    function previewFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('previewContainer').style.display = 'block';
        document.getElementById('previewContainer').querySelector('img').src = e.target.result;
        document.getElementById('previewContainer').querySelector('p').textContent = file.name;
      }
      reader.readAsDataURL(file);
    }

    async function uploadProfilePicture() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        showNotification('Please select a file to upload.', 'error');
        return;
      }

      // Validate file type
      if (!file.type.startsWith('image/')) {
        showNotification('Please select a valid image file.', 'error');
        return;
      }

      // Validate file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        showNotification('File size must be less than 5MB.', 'error');
        return;
      }

      // Compress image before upload to reduce base64 size
      function compressImage(file) {
        return new Promise((resolve) => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = function() {
            // Set maximum dimensions for profile picture
            const maxWidth = 300;
            const maxHeight = 300;
            
            let { width, height } = img;
            
            // Calculate new dimensions maintaining aspect ratio
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Draw and compress image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to base64 with reduced quality
            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            resolve(compressedDataUrl);
          };
          
          img.src = URL.createObjectURL(file);
        });
      }

      // Show progress
      const uploadProgress = document.querySelector('.upload-progress');
      const uploadProgressFill = document.getElementById('uploadProgressFill');
      const progressText = document.querySelector('.progress-text');
      
      uploadProgress.style.display = 'block';
      uploadProgressFill.style.width = '0%';
      progressText.textContent = 'Processing...';

      // Simulate upload progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        uploadProgressFill.style.width = progress + '%';
        progressText.textContent = `Uploading... ${progress}%`;
        
                if (progress >= 100) {
          clearInterval(progressInterval);
          
          // Compress and create a preview URL for the selected image
          compressImage(file).then(async (compressedImageUrl) => {
            try {
                // Get user email from localStorage
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const email = userData.email;
                
                if (!email) {
                  showNotification('User email not found. Please login again.', 'error');
                  return;
                }

                // Save to database via API
                const response = await fetch('/api/user/save-profile-picture/', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    email: email,
                    profile_picture: compressedImageUrl
                  })
                });

              const result = await response.json();

              if (response.ok && result.success) {
                // Update the profile picture
                document.getElementById('profilePicture').src = compressedImageUrl;
                document.getElementById('profilePicture').style.display = 'block';
                document.getElementById('avatarText').style.display = 'none';
                
                // Update localStorage with the profile picture from database
                userData.profile_picture = compressedImageUrl;
                localStorage.setItem('userData', JSON.stringify(userData));
                
                // Show success message
                showNotification('Profile picture updated successfully!', 'success');
                closeProfileUploadModal();
              } else {
                // Show error message
                const errorMessage = result.error || 'Failed to save profile picture';
                const details = result.details ? `\n\nDetails: ${result.details}` : '';
                showNotification(errorMessage + details, 'error');
              }
                        } catch (error) {
              console.error('Error saving profile picture:', error);
              
              showNotification('Network error occurred. Please try again later.', 'error');
            }
          });
        }
      }, 100);
    }




    // Check if user is logged in and populate profile
    // In a real application, you would check for authentication tokens
    window.addEventListener('load', async function() {
      // For demo purposes, we'll try to get user data from localStorage or sessionStorage
      // In production, this would come from a secure authentication system
      await populateUserProfile();
      console.log('User dashboard loaded');
    });




    // Function to populate user profile
    async function populateUserProfile() {
      // Try to get user data from various sources
      let userData = null;
     
      // Check if we have signup data (for demo purposes)
      if (window.signupData) {
        userData = window.signupData;
      }
     
      // Check localStorage (if data was stored there)
      if (!userData) {
        const storedData = localStorage.getItem('userData');
        if (storedData) {
          userData = JSON.parse(storedData);
        }
      }
     
      // Check sessionStorage (if data was stored there)
      if (!userData) {
        const sessionData = sessionStorage.getItem('userData');
        if (sessionData) {
          userData = JSON.parse(sessionData);
        }
      }
     
      // If we have user data, populate the profile
      if (userData) {
        document.getElementById('userFullName').textContent = userData.name || userData.full_name || 'User Name';
        document.getElementById('userEmail').textContent = userData.email || 'user@email.com';
        document.getElementById('userBarangay').textContent = userData.barangay || 'Barangay';
        
        // Try to load profile picture from database first
        if (userData.email) {
          try {
            const response = await fetch('/api/user/get-profile-picture/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                email: userData.email
              })
            });

            const result = await response.json();

            if (response.ok && result.success && result.profile_picture) {
              // Use profile picture from database
              document.getElementById('profilePicture').src = result.profile_picture;
              document.getElementById('profilePicture').style.display = 'block';
              document.getElementById('avatarText').style.display = 'none';
              
              // Update localStorage with the profile picture from database
              userData.profile_picture = result.profile_picture;
              localStorage.setItem('userData', JSON.stringify(userData));
              
              // Clear temporary profile picture if it exists
              localStorage.removeItem('temp_profile_picture');
            } else if (userData.profile_picture) {
              // Fallback to localStorage profile picture
              document.getElementById('profilePicture').src = userData.profile_picture;
              document.getElementById('profilePicture').style.display = 'block';
              document.getElementById('avatarText').style.display = 'none';
            } else {
              // Check for temporary profile picture from logout
              const tempProfilePicture = localStorage.getItem('temp_profile_picture');
              if (tempProfilePicture) {
                document.getElementById('profilePicture').src = tempProfilePicture;
                document.getElementById('profilePicture').style.display = 'block';
                document.getElementById('avatarText').style.display = 'none';
                
                // Move temp profile picture to userData
                userData.profile_picture = tempProfilePicture;
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.removeItem('temp_profile_picture');
              } else {
                // No profile picture found
                document.getElementById('profilePicture').style.display = 'none';
                document.getElementById('avatarText').style.display = 'block';
              }
            }
          } catch (error) {
            console.error('Error loading profile picture from database:', error);
            // Fallback to localStorage profile picture
            if (userData.profile_picture) {
              document.getElementById('profilePicture').src = userData.profile_picture;
              document.getElementById('profilePicture').style.display = 'block';
              document.getElementById('avatarText').style.display = 'none';
            } else {
              // Check for temporary profile picture from logout
              const tempProfilePicture = localStorage.getItem('temp_profile_picture');
              if (tempProfilePicture) {
                document.getElementById('profilePicture').src = tempProfilePicture;
                document.getElementById('profilePicture').style.display = 'block';
                document.getElementById('avatarText').style.display = 'none';
                
                // Move temp profile picture to userData
                userData.profile_picture = tempProfilePicture;
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.removeItem('temp_profile_picture');
              } else {
                document.getElementById('profilePicture').style.display = 'none';
                document.getElementById('avatarText').style.display = 'block';
              }
            }
          }
        } else {
          // No email, use localStorage profile picture if available
          if (userData.profile_picture) {
            document.getElementById('profilePicture').src = userData.profile_picture;
            document.getElementById('profilePicture').style.display = 'block';
            document.getElementById('avatarText').style.display = 'none';
          } else {
            // Check for temporary profile picture from logout
            const tempProfilePicture = localStorage.getItem('temp_profile_picture');
            if (tempProfilePicture) {
              document.getElementById('profilePicture').src = tempProfilePicture;
              document.getElementById('profilePicture').style.display = 'block';
              document.getElementById('avatarText').style.display = 'none';
              
              // Move temp profile picture to userData
              userData.profile_picture = tempProfilePicture;
              localStorage.setItem('userData', JSON.stringify(userData));
              localStorage.removeItem('temp_profile_picture');
            } else {
              document.getElementById('profilePicture').style.display = 'none';
              document.getElementById('avatarText').style.display = 'block';
            }
          }
        }
        
        // Store in localStorage for persistence
        localStorage.setItem('userData', JSON.stringify(userData));
      } else {
        // For demo purposes, show sample data
        document.getElementById('userFullName').textContent = 'John Doe';
        document.getElementById('userEmail').textContent = 'john.doe@example.com';
        document.getElementById('userBarangay').textContent = 'Sample Barangay';
        document.getElementById('profilePicture').style.display = 'none';
        document.getElementById('avatarText').style.display = 'block';
      }
    }

    // User Authentication Check - Only redirect if API call fails
    async function checkUserAuth() {
      try {
        // Try to fetch user data from the server to verify session
        const response = await fetch('/api/user/check-auth/', {
          method: 'GET',
          credentials: 'same-origin'
        });
        
        if (response.status === 401) {
          // User is not authenticated, redirect to login
          window.location.href = '/index.html?show_login=true';
          return;
        }
        
        if (response.ok) {
          const userData = await response.json();
          // Check if user is an admin (admin should not access user pages)
          if (userData.role === 'admin') {
            window.location.href = '/index.html?show_login=true';
            return;
          }
          console.log('User authenticated:', userData.email);
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Don't redirect on network errors, let the user continue
      }
    }

    // CSRF Token helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

         // Toast notification function
     function showToast(message, type = 'info') {
       const toast = document.getElementById('toast');
       toast.textContent = message;
       toast.className = `toast ${type}`;
       toast.classList.add('show');
       
       // Remove after 3 seconds
       setTimeout(() => {
         toast.classList.remove('show');
       }, 3000);
    }

    // Run authentication check when page loads
    document.addEventListener('DOMContentLoaded', function() {
      checkUserAuth();
       // Load user chats
       loadUserChats();
    });
  </script>

   <!-- Toast Notification -->
   <div id="toast" class="toast"></div>
</body>
</html>









