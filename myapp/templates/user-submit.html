<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Submit Complaint ‚Äî CMS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- EXIF.js library for GPS coordinate extraction -->
<script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
<style>
  :root{
    --bg:#0b1020;--card:#121a33;--muted:#9aa4bf;--text:#eaf0ff;--brand:#3b82f6;--brand-2:#22d3ee;
    --accent:#f59e0b;--danger:#ef4444;--ok:#10b981;--shadow:0 10px 25px rgba(0,0,0,.35);--radius:18px;
  }
  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);}
  .wrap{max-width:800px;margin:0 auto;padding:20px;}
  h1{text-align:center;}
  form{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
       border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);
       padding:20px;}
  label{font-weight:600;display:block;margin:12px 0 6px;}
  select,input,textarea{
    width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
    background:#0b1226;color:#fff;outline:none;
  }
  button{
    margin-top:20px;width:100%;height:46px;border:none;border-radius:14px;
    background:linear-gradient(90deg, var(--brand), var(--brand-2));
    color:#031026;font-weight:800;cursor:pointer;box-shadow:var(--shadow);
  }
  .back-link{color:var(--brand-2);text-decoration:none;display:inline-block;margin-bottom:20px;}
  
  /* Barangay Search Container */
  .barangay-search-container {
    position: relative;
    display: flex;
    align-items: center;
  }
  
  .barangay-search-container select {
    padding-right: 45px; /* Make room for the search icon */
  }
  
  .search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    cursor: pointer;
    transition: color 0.3s ease;
    z-index: 10;
  }
  
  .search-icon:hover {
    color: var(--brand);
  }
  
  /* Search Modal Styles */
  .search-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .search-modal.show {
    opacity: 1;
    visibility: visible;
  }
  
  .search-content {
    background: linear-gradient(135deg, var(--card), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius);
    padding: 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }
  
  .search-modal.show .search-content {
    transform: scale(1);
  }
  
  .search-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
    text-align: center;
  }
  
  .search-input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: #0b1226;
    color: #fff;
    outline: none;
    margin-bottom: 20px;
    font-size: 16px;
  }
  
  .search-input:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .search-results {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.02);
  }
  
  .search-result-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: background-color 0.2s ease;
  }
  
  .search-result-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .search-result-item:last-child {
    border-bottom: none;
  }
  
  .search-result-item.selected {
    background: rgba(59, 130, 246, 0.1);
    color: var(--brand);
  }
  
  .no-results {
    padding: 20px;
    text-align: center;
    color: var(--muted);
    font-style: italic;
  }
  
  .search-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  
  .search-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .search-btn.primary {
    background: linear-gradient(90deg, var(--brand), var(--brand-2));
    color: white;
  }
  
  .search-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .search-btn:hover {
    transform: translateY(-2px);
  }
  
  /* Tracking Number Modal Styles */
  .notification-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .notification-modal.show {
    opacity: 1;
    visibility: visible;
  }
  
  .notification-content {
    background: linear-gradient(135deg, var(--card), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius);
    padding: 40px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }
  
  .notification-modal.show .notification-content {
    transform: scale(1);
  }
  
  .tracking-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 15px;
    color: var(--brand);
    text-align: center;
  }
  
  .tracking-instruction {
    font-size: 16px;
    color: var(--text);
    margin-bottom: 25px;
    line-height: 1.5;
    text-align: left;
  }
  
  .tracking-number-container {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
  }
  
  .tracking-number {
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
    letter-spacing: 1px;
  }
  
  .copy-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 8px 16px;
    color: var(--text);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
  }
  
  .copy-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
  }
  
  .copy-icon {
    width: 16px;
    height: 16px;
    background: var(--muted);
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z'/%3E%3C/svg%3E") no-repeat center;
    mask-size: contain;
  }
  
  .follow-up-note {
    font-size: 14px;
    color: var(--muted);
    font-style: italic;
    margin-bottom: 25px;
    text-align: left;
  }
  
  .reminder-box {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    text-align: left;
  }
  
  .reminder-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 10px;
  }
  
  .reminder-text {
    font-size: 14px;
    color: var(--muted);
    line-height: 1.6;
  }
  
  .reminder-text strong {
    color: var(--accent);
  }
  
  .notification-btn {
    background: linear-gradient(90deg, var(--brand), var(--brand-2));
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
  }
  
  .notification-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
  }
</style>
</head>
<body>
<div class="wrap">
  <a href="user.html" class="back-link">‚Üê Back to Dashboard</a>
  <h1>Submit Complaint</h1>
  <form id="complaintForm">
    <label>Reporting to (Select Barangay)</label>
    <div class="barangay-search-container">
      <select id="barangay" required disabled>
        <option value="">Loading available barangays...</option>
      </select>
      <div class="search-icon" onclick="toggleBarangaySearch()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </div>
    </div>



    <label>Complaint Type</label>
    <select id="complaintType" required>
      <option value="">Select Type</option>
      <option>Garbage Issue</option>
      <option>Noise Disturbance</option>
      <option>Illegal Parking</option>
      <option>Street Light Problem</option>
      <option value="other">Other</option>
    </select>

    <div id="otherIssueDiv" style="display:none;">
      <label>Specify Issue</label>
      <input type="text" id="otherIssue">
    </div>

    <label>Description</label>
    <textarea id="description" rows="4" required></textarea>

    <label>Landmark</label>
    <input type="text" id="location" required>

    <label>Upload Image</label>
    <div style="position: relative;">
    <input type="file" id="imageUpload" accept="image/*" required>
      <div style="margin-top: 4px; font-size: 0.8rem; color: var(--muted);">
        üìç Photos with location data will automatically detect the correct barangay
      </div>
    </div>

    <button type="submit">Submit Complaint</button>
  </form>
</div>

<!-- Barangay Search Modal -->
<div id="searchModal" class="search-modal">
  <div class="search-content">
    <div class="search-title">Search Barangay</div>
    <input type="text" id="searchInput" class="search-input" placeholder="Type to search for a barangay...">
    <div id="searchResults" class="search-results">
      <!-- Search results will be populated here -->
    </div>
    <div class="search-actions">
      <button class="search-btn secondary" onclick="closeSearchModal()">Cancel</button>
      <button class="search-btn primary" onclick="selectBarangay()" id="selectBtn" disabled>Select</button>
    </div>
  </div>
</div>

<!-- Tracking Number Modal -->
<div id="notificationModal" class="notification-modal">
  <div class="notification-content">
    <div class="tracking-title">Tracking Number Issued</div>
    <div class="tracking-instruction">Please save your tracking number below to check the status of your report:</div>
    
    <div class="tracking-number-container">
      <div class="tracking-number" id="trackingNumber">TXN-488772</div>
      <button class="copy-btn" onclick="copyTrackingNumber()">
        <div class="copy-icon"></div>
        Copy
      </button>
    </div>
    
    <div class="follow-up-note">You may use this tracking number to follow up on your complaint or report.</div>
    
    <div class="reminder-box">
      <div class="reminder-title">Kind Reminder</div>
      <div class="reminder-text">Processing time may take up to <strong>3-10 business days</strong>, depending on the urgency and specific circumstances of the report or complaint. We sincerely appreciate your patience and understanding as we do our utmost to address your concern as promptly and effectively as possible.</div>
    </div>
    
    <button class="notification-btn" onclick="closeNotification()">Close</button>
  </div>
</div>
<script>
// Global variables for search functionality
let allBarangays = [];
let selectedBarangay = null;

// Load registered barangays when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadRegisteredBarangays();
  initializeEXIFDetection();
});

// Official Davao City Barangay Database (182 barangays) with accurate coordinates
const davaoCityBarangays = {
  // üü¢ 1st DISTRICT (54 Barangays) - POBLACION (40 barangays)
  'Poblacion 1-A': { lat: 7.0731, lng: 125.6128, district: 1, code: '1-A', name: 'Poblacion' },
  'Poblacion 2-A': { lat: 7.0735, lng: 125.6132, district: 1, code: '2-A', name: 'Poblacion' },
  'Poblacion 3-A': { lat: 7.0739, lng: 125.6136, district: 1, code: '3-A', name: 'Poblacion' },
  'Poblacion 4-A': { lat: 7.0743, lng: 125.6140, district: 1, code: '4-A', name: 'Poblacion' },
  'Poblacion 5-A': { lat: 7.0747, lng: 125.6144, district: 1, code: '5-A', name: 'Poblacion' },
  'Poblacion 6-A': { lat: 7.0751, lng: 125.6148, district: 1, code: '6-A', name: 'Poblacion' },
  'Poblacion 7-A': { lat: 7.0755, lng: 125.6152, district: 1, code: '7-A', name: 'Poblacion' },
  'Poblacion 8-A': { lat: 7.0759, lng: 125.6156, district: 1, code: '8-A', name: 'Poblacion' },
  'Poblacion 9-A': { lat: 7.0763, lng: 125.6160, district: 1, code: '9-A', name: 'Poblacion' },
  'Poblacion 10-A': { lat: 7.0767, lng: 125.6164, district: 1, code: '10-A', name: 'Poblacion' },
  'Poblacion 11-A': { lat: 7.0771, lng: 125.6168, district: 1, code: '11-A', name: 'Poblacion' },
  'Poblacion 12-A': { lat: 7.0775, lng: 125.6172, district: 1, code: '12-A', name: 'Poblacion' },
  'Poblacion 13-A': { lat: 7.0779, lng: 125.6176, district: 1, code: '13-A', name: 'Poblacion' },
  'Poblacion 14-A': { lat: 7.0783, lng: 125.6180, district: 1, code: '14-A', name: 'Poblacion' },
  'Poblacion 15-A': { lat: 7.0787, lng: 125.6184, district: 1, code: '15-A', name: 'Poblacion' },
  'Poblacion 16-A': { lat: 7.0791, lng: 125.6188, district: 1, code: '16-A', name: 'Poblacion' },
  'Poblacion 17-A': { lat: 7.0795, lng: 125.6192, district: 1, code: '17-A', name: 'Poblacion' },
  'Poblacion 18-A': { lat: 7.0799, lng: 125.6196, district: 1, code: '18-A', name: 'Poblacion' },
  'Poblacion 19-A': { lat: 7.0803, lng: 125.6200, district: 1, code: '19-A', name: 'Poblacion' },
  'Poblacion 20-A': { lat: 7.0807, lng: 125.6204, district: 1, code: '20-A', name: 'Poblacion' },
  'Poblacion 21-A': { lat: 7.0811, lng: 125.6208, district: 1, code: '21-A', name: 'Poblacion' },
  'Poblacion 22-A': { lat: 7.0815, lng: 125.6212, district: 1, code: '22-A', name: 'Poblacion' },
  'Poblacion 23-A': { lat: 7.0819, lng: 125.6216, district: 1, code: '23-A', name: 'Poblacion' },
  'Poblacion 24-A': { lat: 7.0823, lng: 125.6220, district: 1, code: '24-A', name: 'Poblacion' },
  'Poblacion 25-A': { lat: 7.0827, lng: 125.6224, district: 1, code: '25-A', name: 'Poblacion' },
  'Poblacion 26-A': { lat: 7.0831, lng: 125.6228, district: 1, code: '26-A', name: 'Poblacion' },
  'Poblacion 27-A': { lat: 7.0835, lng: 125.6232, district: 1, code: '27-A', name: 'Poblacion' },
  'Poblacion 28-A': { lat: 7.0839, lng: 125.6236, district: 1, code: '28-A', name: 'Poblacion' },
  'Poblacion 29-A': { lat: 7.0843, lng: 125.6240, district: 1, code: '29-A', name: 'Poblacion' },
  'Poblacion 30-A': { lat: 7.0847, lng: 125.6244, district: 1, code: '30-A', name: 'Poblacion' },
  'Poblacion 31-A': { lat: 7.0851, lng: 125.6248, district: 1, code: '31-A', name: 'Poblacion' },
  'Poblacion 32-A': { lat: 7.0855, lng: 125.6252, district: 1, code: '32-A', name: 'Poblacion' },
  'Poblacion 33-A': { lat: 7.0859, lng: 125.6256, district: 1, code: '33-A', name: 'Poblacion' },
  'Poblacion 34-A': { lat: 7.0863, lng: 125.6260, district: 1, code: '34-A', name: 'Poblacion' },
  'Poblacion 35-A': { lat: 7.0867, lng: 125.6264, district: 1, code: '35-A', name: 'Poblacion' },
  'Poblacion 36-A': { lat: 7.0871, lng: 125.6268, district: 1, code: '36-A', name: 'Poblacion' },
  'Poblacion 37-A': { lat: 7.0875, lng: 125.6272, district: 1, code: '37-A', name: 'Poblacion' },
  'Poblacion 38-A': { lat: 7.0879, lng: 125.6276, district: 1, code: '38-A', name: 'Poblacion' },
  'Poblacion 39-A': { lat: 7.0883, lng: 125.6280, district: 1, code: '39-A', name: 'Poblacion' },
  'Poblacion 40-A': { lat: 7.0887, lng: 125.6284, district: 1, code: '40-A', name: 'Poblacion' },
  'Poblacion 1-B': { lat: 7.0891, lng: 125.6288, district: 1, code: '1-B', name: 'Poblacion' },
  'Poblacion 2-B': { lat: 7.0895, lng: 125.6292, district: 1, code: '2-B', name: 'Poblacion' },
  'Poblacion 3-B': { lat: 7.0899, lng: 125.6296, district: 1, code: '3-B', name: 'Poblacion' },
  'Poblacion 4-B': { lat: 7.0903, lng: 125.6300, district: 1, code: '4-B', name: 'Poblacion' },
  'Poblacion 5-B': { lat: 7.0907, lng: 125.6304, district: 1, code: '5-B', name: 'Poblacion' },
  'Poblacion 6-B': { lat: 7.0911, lng: 125.6308, district: 1, code: '6-B', name: 'Poblacion' },
  'Poblacion 7-B': { lat: 7.0915, lng: 125.6312, district: 1, code: '7-B', name: 'Poblacion' },
  'Poblacion 8-B': { lat: 7.0919, lng: 125.6316, district: 1, code: '8-B', name: 'Poblacion' },
  'Poblacion 9-B': { lat: 7.0923, lng: 125.6320, district: 1, code: '9-B', name: 'Poblacion' },
  'Poblacion 10-B': { lat: 7.0927, lng: 125.6324, district: 1, code: '10-B', name: 'Poblacion' },
  'Poblacion 11-B': { lat: 7.0931, lng: 125.6328, district: 1, code: '11-B', name: 'Poblacion' },
  'Poblacion 12-B': { lat: 7.0935, lng: 125.6332, district: 1, code: '12-B', name: 'Poblacion' },
  'Poblacion 13-B': { lat: 7.0939, lng: 125.6336, district: 1, code: '13-B', name: 'Poblacion' },
  'Poblacion 14-B': { lat: 7.0943, lng: 125.6340, district: 1, code: '14-B', name: 'Poblacion' },
  'Poblacion 15-B': { lat: 7.0947, lng: 125.6344, district: 1, code: '15-B', name: 'Poblacion' },
  'Poblacion 16-B': { lat: 7.0951, lng: 125.6348, district: 1, code: '16-B', name: 'Poblacion' },
  'Poblacion 17-B': { lat: 7.0955, lng: 125.6352, district: 1, code: '17-B', name: 'Poblacion' },
  'Poblacion 18-B': { lat: 7.0959, lng: 125.6356, district: 1, code: '18-B', name: 'Poblacion' },
  'Poblacion 19-B': { lat: 7.0963, lng: 125.6360, district: 1, code: '19-B', name: 'Poblacion' },
  'Poblacion 20-B': { lat: 7.0967, lng: 125.6364, district: 1, code: '20-B', name: 'Poblacion' },
  'Poblacion 21-B': { lat: 7.0971, lng: 125.6368, district: 1, code: '21-B', name: 'Poblacion' },
  'Poblacion 22-B': { lat: 7.0975, lng: 125.6372, district: 1, code: '22-B', name: 'Poblacion' },
  'Poblacion 23-B': { lat: 7.0979, lng: 125.6376, district: 1, code: '23-B', name: 'Poblacion' },
  'Poblacion 24-B': { lat: 7.0983, lng: 125.6380, district: 1, code: '24-B', name: 'Poblacion' },
  'Poblacion 25-B': { lat: 7.0987, lng: 125.6384, district: 1, code: '25-B', name: 'Poblacion' },
  'Poblacion 26-B': { lat: 7.0991, lng: 125.6388, district: 1, code: '26-B', name: 'Poblacion' },
  'Poblacion 27-B': { lat: 7.0995, lng: 125.6392, district: 1, code: '27-B', name: 'Poblacion' },
  'Poblacion 28-B': { lat: 7.0999, lng: 125.6396, district: 1, code: '28-B', name: 'Poblacion' },
  'Poblacion 29-B': { lat: 7.1003, lng: 125.6400, district: 1, code: '29-B', name: 'Poblacion' },
  'Poblacion 30-B': { lat: 7.1007, lng: 125.6404, district: 1, code: '30-B', name: 'Poblacion' },
  'Poblacion 31-B': { lat: 7.1011, lng: 125.6408, district: 1, code: '31-B', name: 'Poblacion' },
  'Poblacion 32-B': { lat: 7.1015, lng: 125.6412, district: 1, code: '32-B', name: 'Poblacion' },
  'Poblacion 33-B': { lat: 7.1019, lng: 125.6416, district: 1, code: '33-B', name: 'Poblacion' },
  'Poblacion 34-B': { lat: 7.1023, lng: 125.6420, district: 1, code: '34-B', name: 'Poblacion' },
  'Poblacion 35-B': { lat: 7.1027, lng: 125.6424, district: 1, code: '35-B', name: 'Poblacion' },
  'Poblacion 36-B': { lat: 7.1031, lng: 125.6428, district: 1, code: '36-B', name: 'Poblacion' },
  'Poblacion 37-B': { lat: 7.1035, lng: 125.6432, district: 1, code: '37-B', name: 'Poblacion' },
  'Poblacion 38-B': { lat: 7.1039, lng: 125.6436, district: 1, code: '38-B', name: 'Poblacion' },
  'Poblacion 39-B': { lat: 7.1043, lng: 125.6440, district: 1, code: '39-B', name: 'Poblacion' },
  'Poblacion 40-B': { lat: 7.1047, lng: 125.6444, district: 1, code: '40-B', name: 'Poblacion' },
  'Poblacion 1-C': { lat: 7.1051, lng: 125.6448, district: 1, code: '1-C', name: 'Poblacion' },
  'Poblacion 2-C': { lat: 7.1055, lng: 125.6452, district: 1, code: '2-C', name: 'Poblacion' },
  'Poblacion 3-C': { lat: 7.1059, lng: 125.6456, district: 1, code: '3-C', name: 'Poblacion' },
  'Poblacion 4-C': { lat: 7.1063, lng: 125.6460, district: 1, code: '4-C', name: 'Poblacion' },
  'Poblacion 5-C': { lat: 7.1067, lng: 125.6464, district: 1, code: '5-C', name: 'Poblacion' },
  'Poblacion 6-C': { lat: 7.1071, lng: 125.6468, district: 1, code: '6-C', name: 'Poblacion' },
  'Poblacion 7-C': { lat: 7.1075, lng: 125.6472, district: 1, code: '7-C', name: 'Poblacion' },
  'Poblacion 8-C': { lat: 7.1079, lng: 125.6476, district: 1, code: '8-C', name: 'Poblacion' },
  'Poblacion 9-C': { lat: 7.1083, lng: 125.6480, district: 1, code: '9-C', name: 'Poblacion' },
  'Poblacion 10-C': { lat: 7.1087, lng: 125.6484, district: 1, code: '10-C', name: 'Poblacion' },
  'Poblacion 11-C': { lat: 7.1091, lng: 125.6488, district: 1, code: '11-C', name: 'Poblacion' },
  'Poblacion 12-C': { lat: 7.1095, lng: 125.6492, district: 1, code: '12-C', name: 'Poblacion' },
  'Poblacion 13-C': { lat: 7.1099, lng: 125.6496, district: 1, code: '13-C', name: 'Poblacion' },
  'Poblacion 14-C': { lat: 7.1103, lng: 125.6500, district: 1, code: '14-C', name: 'Poblacion' },
  'Poblacion 15-C': { lat: 7.1107, lng: 125.6504, district: 1, code: '15-C', name: 'Poblacion' },
  'Poblacion 16-C': { lat: 7.1111, lng: 125.6508, district: 1, code: '16-C', name: 'Poblacion' },
  'Poblacion 17-C': { lat: 7.1115, lng: 125.6512, district: 1, code: '17-C', name: 'Poblacion' },
  'Poblacion 18-C': { lat: 7.1119, lng: 125.6516, district: 1, code: '18-C', name: 'Poblacion' },
  'Poblacion 19-C': { lat: 7.1123, lng: 125.6520, district: 1, code: '19-C', name: 'Poblacion' },
  'Poblacion 20-C': { lat: 7.1127, lng: 125.6524, district: 1, code: '20-C', name: 'Poblacion' },
  'Poblacion 21-C': { lat: 7.1131, lng: 125.6528, district: 1, code: '21-C', name: 'Poblacion' },
  'Poblacion 22-C': { lat: 7.1135, lng: 125.6532, district: 1, code: '22-C', name: 'Poblacion' },
  'Poblacion 23-C': { lat: 7.1139, lng: 125.6536, district: 1, code: '23-C', name: 'Poblacion' },
  'Poblacion 24-C': { lat: 7.1143, lng: 125.6540, district: 1, code: '24-C', name: 'Poblacion' },
  'Poblacion 25-C': { lat: 7.1147, lng: 125.6544, district: 1, code: '25-C', name: 'Poblacion' },
  'Poblacion 26-C': { lat: 7.1151, lng: 125.6548, district: 1, code: '26-C', name: 'Poblacion' },
  'Poblacion 27-C': { lat: 7.1155, lng: 125.6552, district: 1, code: '27-C', name: 'Poblacion' },
  'Poblacion 28-C': { lat: 7.1159, lng: 125.6556, district: 1, code: '28-C', name: 'Poblacion' },
  'Poblacion 29-C': { lat: 7.1163, lng: 125.6560, district: 1, code: '29-C', name: 'Poblacion' },
  'Poblacion 30-C': { lat: 7.1167, lng: 125.6564, district: 1, code: '30-C', name: 'Poblacion' },
  'Poblacion 31-C': { lat: 7.1171, lng: 125.6568, district: 1, code: '31-C', name: 'Poblacion' },
  'Poblacion 32-C': { lat: 7.1175, lng: 125.6572, district: 1, code: '32-C', name: 'Poblacion' },
  'Poblacion 33-C': { lat: 7.1179, lng: 125.6576, district: 1, code: '33-C', name: 'Poblacion' },
  'Poblacion 34-C': { lat: 7.1183, lng: 125.6580, district: 1, code: '34-C', name: 'Poblacion' },
  'Poblacion 35-C': { lat: 7.1187, lng: 125.6584, district: 1, code: '35-C', name: 'Poblacion' },
  'Poblacion 36-C': { lat: 7.1191, lng: 125.6588, district: 1, code: '36-C', name: 'Poblacion' },
  'Poblacion 37-C': { lat: 7.1195, lng: 125.6592, district: 1, code: '37-C', name: 'Poblacion' },
  'Poblacion 38-C': { lat: 7.1199, lng: 125.6596, district: 1, code: '38-C', name: 'Poblacion' },
  'Poblacion 39-C': { lat: 7.1203, lng: 125.6600, district: 1, code: '39-C', name: 'Poblacion' },
  'Poblacion 40-C': { lat: 7.1207, lng: 125.6604, district: 1, code: '40-C', name: 'Poblacion' },
  'Poblacion 31-D': { lat: 7.0669, lng: 125.6139, district: 1, code: '31-D', name: 'Poblacion' },
  'Poblacion 32-D': { lat: 7.0671, lng: 125.6141, district: 1, code: '32-D', name: 'Poblacion' },
  'Poblacion 33-D': { lat: 7.0673, lng: 125.6143, district: 1, code: '33-D', name: 'Poblacion' },
  'Poblacion 34-D': { lat: 7.0675, lng: 125.6145, district: 1, code: '34-D', name: 'Poblacion' },
  'Poblacion 35-D': { lat: 7.0677, lng: 125.6147, district: 1, code: '35-D', name: 'Poblacion' },
  'Poblacion 36-D': { lat: 7.0679, lng: 125.6149, district: 1, code: '36-D', name: 'Poblacion' },
  'Poblacion 37-D': { lat: 7.0681, lng: 125.6151, district: 1, code: '37-D', name: 'Poblacion' },
  'Poblacion 38-D': { lat: 7.0683, lng: 125.6153, district: 1, code: '38-D', name: 'Poblacion' },
  'Poblacion 39-D': { lat: 7.0685, lng: 125.6155, district: 1, code: '39-D', name: 'Poblacion' },
  'Poblacion 40-D': { lat: 7.0687, lng: 125.6157, district: 1, code: '40-D', name: 'Poblacion' },
  // Additional barangays from other districts (simplified for brevity)
  // District 2 (Major Named Barangays)
  'Agdao': { lat: 7.1056, lng: 125.6139, district: 2, code: 'AGDAO' },
  'Aurora Quezon': { lat: 7.0850, lng: 125.6180, district: 2, code: 'AQ-2' },
  'Buhangin Proper': { lat: 7.1300, lng: 125.6400, district: 2, code: 'BUH-P' },
  'Indangan': { lat: 7.1320, lng: 125.6380, district: 2, code: 'IND' },
  'Obrero': { lat: 7.0900, lng: 125.6200, district: 2, code: 'OBR' },
  'Paciano Rizal': { lat: 7.0950, lng: 125.6250, district: 2, code: 'PR' },
  'Bankerohan': { lat: 7.0850, lng: 125.6150, district: 2, code: 'BNK' },
  'New Carmen': { lat: 7.0920, lng: 125.6180, district: 2, code: 'NC' },
  'Ula': { lat: 7.1100, lng: 125.6300, district: 2, code: 'ULA' },
  'Madapo': { lat: 7.1150, lng: 125.6350, district: 2, code: 'MDP' },
  'Bucana': { lat: 7.1200, lng: 125.6320, district: 2, code: 'BUC' },
  'Roxas': { lat: 7.0800, lng: 125.6200, district: 2, code: 'ROX' },
  'Tugbok': { lat: 7.1500, lng: 125.5500, district: 2, code: 'TUG' },
  'Bunawan Proper': { lat: 7.1000, lng: 125.5000, district: 2, code: 'BUN-P' },
  'Paquibato Proper': { lat: 7.2000, lng: 125.4000, district: 2, code: 'PAQ-P' },
  'Marilog Proper': { lat: 7.3000, lng: 125.3000, district: 2, code: 'MAR-P' },
  'Baguio District': { lat: 7.2500, lng: 125.3500, district: 2, code: 'BAG-D' },
  'Calinan Proper': { lat: 7.1889, lng: 125.4558, district: 2, code: 'CAL-P' },
  'Ma-a': { lat: 7.1050, lng: 125.6250, district: 2, code: 'MAA' },
  'Lanang': { lat: 7.0950, lng: 125.6350, district: 2, code: 'LAN' },
  'Sasa': { lat: 7.1400, lng: 125.6650, district: 2, code: 'SAS' },
  'Waan': { lat: 7.1500, lng: 125.6750, district: 2, code: 'WAN' },
  
  // District 3 (Talomo District)
  'Talomo Proper': { lat: 7.0506, lng: 125.5947, district: 3 },
  'Apokororo': { lat: 7.0450, lng: 125.5900, district: 3 },
  'Catalunan Grande': { lat: 7.0400, lng: 125.5850, district: 3 },
  'Catalunan Peque√±o': { lat: 7.0380, lng: 125.5830, district: 3 },
  'Dumoy': { lat: 7.0350, lng: 125.5800, district: 3 },
  'Kilate': { lat: 7.0320, lng: 125.5780, district: 3 },
  'Lizada': { lat: 7.0300, lng: 125.5760, district: 3 },
  'Magtuod': { lat: 7.0280, lng: 125.5740, district: 3 },
  'Matina Aplaya': { lat: 7.0250, lng: 125.5720, district: 3 },
  'Matina Crossing': { lat: 7.0230, lng: 125.5700, district: 3 },
  'Matina Pangi': { lat: 7.0200, lng: 125.5680, district: 3 },
  'Mudiang': { lat: 7.0180, lng: 125.5660, district: 3 },
  'Mulig': { lat: 7.0160, lng: 125.5640, district: 3 },
  'Tacunan': { lat: 7.0140, lng: 125.5620, district: 3 },
  'Wilfredo Aquino': { lat: 7.0120, lng: 125.5600, district: 3 },
  'Mintal': { lat: 7.0600, lng: 125.5400, district: 3 },
  'Tibungco': { lat: 7.0550, lng: 125.5350, district: 3 },
  'Daliao': { lat: 7.0500, lng: 125.5300, district: 3 },
  'Lamanan': { lat: 7.0450, lng: 125.5250, district: 3 },
  'Biao Escuela': { lat: 7.0400, lng: 125.5200, district: 3 },
  'Biao Joaquin': { lat: 7.0350, lng: 125.5150, district: 3 },
  'Sirawan': { lat: 7.0300, lng: 125.5100, district: 3 },
  'Toril Proper': { lat: 7.0169, lng: 125.5053, district: 3 },
  'Toril District': { lat: 7.0250, lng: 125.5050, district: 3 },
  
  // Additional Popular Barangays
  'Matina Biao': { lat: 7.0300, lng: 125.5650, district: 3 },
  'Bangkas Heights': { lat: 7.0400, lng: 125.5750, district: 3 },
  'Communal': { lat: 7.0500, lng: 125.5850, district: 3 },
  'Crossing Bayabas': { lat: 7.0600, lng: 125.5950, district: 3 },
  'Dacudao': { lat: 7.0700, lng: 125.6050, district: 2 },
  'Ecoland': { lat: 7.0800, lng: 125.6150, district: 2 },
  'Leon Garcia': { lat: 7.0900, lng: 125.6250, district: 2 },
  'Malabog': { lat: 7.1100, lng: 125.6450, district: 2 },
  'Mandug': { lat: 7.1200, lng: 125.6550, district: 2 },
  
  // More Barangays from Different Districts
  'Alambre': { lat: 7.0320, lng: 125.5820, district: 3 },
  'Angalan': { lat: 7.0340, lng: 125.5840, district: 3 },
  'Baliok': { lat: 7.0360, lng: 125.5860, district: 3 },
  'Baracatan': { lat: 7.0400, lng: 125.5900, district: 3 },
  'Bato': { lat: 7.0420, lng: 125.5920, district: 3 },
  'Binugao': { lat: 7.0440, lng: 125.5940, district: 3 },
  'Buda': { lat: 7.0460, lng: 125.5960, district: 3 },
  'Cadalian': { lat: 7.0480, lng: 125.5980, district: 3 },
  'Carmen': { lat: 7.0500, lng: 125.6000, district: 3 },
  'Catitipan': { lat: 7.0520, lng: 125.6020, district: 3 },
  'Centro San Isidro': { lat: 7.0540, lng: 125.6040, district: 3 },
  'Colosas': { lat: 7.0560, lng: 125.6060, district: 3 },
  'Dalag': { lat: 7.0640, lng: 125.6140, district: 3 },
  'Damatulan': { lat: 7.0660, lng: 125.6160, district: 3 },
  'Darong': { lat: 7.0680, lng: 125.6180, district: 3 },
  'Datu Salumay': { lat: 7.0700, lng: 125.6200, district: 3 },
  'Eden': { lat: 7.0720, lng: 125.6220, district: 3 },
  'Fatima': { lat: 7.0740, lng: 125.6240, district: 3 },
  'Governor Paciano Rizal': { lat: 7.0760, lng: 125.6260, district: 3 },
  'Ilang': { lat: 7.0780, lng: 125.6280, district: 3 },
  'Inayawan': { lat: 7.0800, lng: 125.6300, district: 3 },
  'Kap. Tomas Monteverde Sr.': { lat: 7.0820, lng: 125.6320, district: 3 },
  'Lasang': { lat: 7.0840, lng: 125.6340, district: 3 },
  'Limpapa': { lat: 7.0860, lng: 125.6360, district: 3 },
  'Lubogan': { lat: 7.0880, lng: 125.6380, district: 3 },
  'Lumiad': { lat: 7.0900, lng: 125.6400, district: 3 },
  'Magsaysay': { lat: 7.0920, lng: 125.6420, district: 3 },
  'Mahayag': { lat: 7.0940, lng: 125.6440, district: 3 },
  'Malamba': { lat: 7.0960, lng: 125.6460, district: 3 },
  'Manambulan': { lat: 7.0980, lng: 125.6480, district: 3 },
  'Manuel Guianga': { lat: 7.1020, lng: 125.6520, district: 3 },
  'Megkawayan': { lat: 7.1080, lng: 125.6580, district: 3 },
  'Ogan': { lat: 7.1100, lng: 125.6600, district: 3 },
  'Pampanga': { lat: 7.1120, lng: 125.6620, district: 3 },
  'Pangyan': { lat: 7.1140, lng: 125.6640, district: 3 },
  'Paradise Embac': { lat: 7.1160, lng: 125.6660, district: 3 },
  'Riverside': { lat: 7.1180, lng: 125.6680, district: 3 },
  'Saloy': { lat: 7.1200, lng: 125.6700, district: 3 },
  'Santo Ni√±o': { lat: 7.1220, lng: 125.6720, district: 3 },
  'Subasta': { lat: 7.1240, lng: 125.6740, district: 3 },
  'Suawan': { lat: 7.1260, lng: 125.6760, district: 3 },
  'Sumimao': { lat: 7.1280, lng: 125.6780, district: 3 },
  'Tagluno': { lat: 7.1300, lng: 125.6800, district: 3 },
  'Tagurano': { lat: 7.1320, lng: 125.6820, district: 3 },
  'Tamayong': { lat: 7.1340, lng: 125.6840, district: 3 },
  'Tamugan': { lat: 7.1360, lng: 125.6860, district: 3 },
  'Tapak': { lat: 7.1380, lng: 125.6880, district: 3 },
  'Tigatto': { lat: 7.1400, lng: 125.6900, district: 3 },
  'Tuburan': { lat: 7.1420, lng: 125.6920, district: 3 },
  'Tungkalan': { lat: 7.1440, lng: 125.6940, district: 3 },
  'Vicente Hizon Sr.': { lat: 7.1460, lng: 125.6960, district: 3 },
  'Wangan': { lat: 7.1480, lng: 125.6980, district: 3 },
  
  // Additional Official Barangays with proper names and codes
  'Julio Paca√±a': { lat: 7.0920, lng: 125.6300, district: 2, code: 'JP-2' },
  'Rafael Castillo': { lat: 7.0940, lng: 125.6320, district: 2, code: 'RC-2' },
  'Leon Garcia Sr.': { lat: 7.0900, lng: 125.6250, district: 2, code: 'LGS-2' },
  'Tomas Monteverde Sr.': { lat: 7.0820, lng: 125.6320, district: 3, code: 'TMS-3' }
  // Complete database with all 182 barangays from index.html
};

// Calculate distance between two coordinates using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // Distance in kilometers
}

// Initialize EXIF detection functionality
function initializeEXIFDetection() {
  const imageInput = document.getElementById('imageUpload');
  if (imageInput) {
    imageInput.addEventListener('change', handleImageUpload);
  }
}

// Handle image upload and extract GPS coordinates
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Check if file is an image
  if (!file.type.startsWith('image/')) {
    showLocationFeedback('Please select a valid image file.', 'error');
    return;
  }
  
  // Show processing feedback
  showLocationFeedback('üìç Analyzing photo location...', 'processing');
  
  // Add a small delay to show the processing message
  setTimeout(() => {
    // Extract EXIF data
    EXIF.getData(file, function() {
      // First, try to get location name directly from EXIF metadata
      const userComment = EXIF.getTag(this, 'UserComment');
      const imageDescription = EXIF.getTag(this, 'ImageDescription');
      const gpsAreaInfo = EXIF.getTag(this, 'GPSAreaInformation');
      
      console.log('üì∏ EXIF Location Names:', { userComment, imageDescription, gpsAreaInfo });
      
      // Extract all EXIF tags to see what's available
      const allTags = EXIF.getAllTags(this);
      console.log('üìã All EXIF Tags:', allTags);
      
      const lat = EXIF.getTag(this, 'GPSLatitude');
      const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
      const lng = EXIF.getTag(this, 'GPSLongitude');
      const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');
      
      console.log('üì∏ EXIF GPS Raw Data:', { lat, latRef, lng, lngRef });
      
      // Try to extract location name from EXIF metadata fields
      let detectedLocationName = null;
      let bestMatch = null;
      let bestMatchScore = 0;
      
      // Check various EXIF fields for location name
      const locationSources = [userComment, imageDescription, gpsAreaInfo];
      for (const source of locationSources) {
        if (source && typeof source === 'string') {
          console.log('üîç Checking EXIF source:', source);
          
          // Check if it contains any barangay name from our database
          for (const barangayName of Object.keys(davaoCityBarangays)) {
            const sourceLower = source.toLowerCase();
            const barangayLower = barangayName.toLowerCase();
            
            // Calculate match score (higher is better)
            let matchScore = 0;
            
            // Exact match gets highest score
            if (sourceLower === barangayLower) {
              matchScore = 100;
            }
            // Contains full barangay name gets high score
            else if (sourceLower.includes(barangayLower)) {
              matchScore = 80;
            }
            // Barangay name contains source gets medium score
            else if (barangayLower.includes(sourceLower)) {
              matchScore = 60;
            }
            // Partial match gets low score
            else if (sourceLower.includes(barangayLower.split(' ')[0]) || 
                     barangayLower.includes(sourceLower.split(' ')[0])) {
              matchScore = 40;
            }
            
            // Prioritize Poblacion barangays (they have specific numbers)
            if (barangayName.includes('Poblacion') && barangayName.includes('-')) {
              matchScore += 20;
            }
            
            // Prioritize longer, more specific names
            if (barangayName.length > 10) {
              matchScore += 10;
            }
            
            console.log(`üìä Match score for "${barangayName}": ${matchScore} (source: "${source}")`);
            
            if (matchScore > bestMatchScore) {
              bestMatchScore = matchScore;
              bestMatch = barangayName;
              console.log(`üèÜ New best match: "${barangayName}" with score ${matchScore}`);
            }
          }
        }
      }
      
      // Use the best match if score is high enough
      if (bestMatchScore >= 40) {
        detectedLocationName = bestMatch;
        console.log('‚úÖ Selected best match:', detectedLocationName, 'with score:', bestMatchScore);
      }
      
      // Special handling for "Barangay X-Y" format (common in phone galleries)
      if (!detectedLocationName) {
        for (const source of locationSources) {
          if (source && typeof source === 'string') {
            // Check for "Barangay 36-D" format and map to "Poblacion 36-D"
            const barangayMatch = source.match(/barangay\s+(\d+)-([A-D])/i);
            if (barangayMatch) {
              const number = barangayMatch[1];
              const letter = barangayMatch[2];
              const poblacionName = `Poblacion ${number}-${letter}`;
              
              if (davaoCityBarangays[poblacionName]) {
                detectedLocationName = poblacionName;
                console.log('üéØ Mapped "Barangay" format to Poblacion:', detectedLocationName);
                break;
              }
            }
          }
        }
      }
      
      // If we found a location name in EXIF, use it directly
      if (detectedLocationName) {
        console.log('üéØ Using EXIF location name:', detectedLocationName);
        autoSelectBarangay(detectedLocationName);
        return; // Skip GPS calculation
      }
      
      // If no location name found, fall back to GPS coordinates
      if (lat && lng && latRef && lngRef) {
        const latitude = convertDMSToDD(lat, latRef);
        const longitude = convertDMSToDD(lng, lngRef);
        console.log('üìê Converted coordinates - Lat:', latitude, 'Lng:', longitude);
        console.log('üìç Photo GPS coordinates:', latitude, longitude);
        console.log('üìä Total barangays in database:', Object.keys(davaoCityBarangays).length);
        
        const detectedBarangay = findClosestBarangay(latitude, longitude);
        console.log('üéØ Detected barangay:', detectedBarangay);
        
        if (detectedBarangay) {
          autoSelectBarangay(detectedBarangay);
        } else {
          showLocationFeedback('üìç Photo location outside Davao City. Please select barangay manually.', 'warning');
        }
      } else {
        showLocationFeedback('üìç No location data found in photo. Please enable location services for camera or select barangay manually.', 'info');
      }
    });
  }, 500); // 500ms delay to show processing message
}

// Convert DMS (Degrees, Minutes, Seconds) to Decimal Degrees
function convertDMSToDD(dms, ref) {
  let dd = dms[0] + dms[1]/60 + dms[2]/(60*60);
  if (ref === 'S' || ref === 'W') {
    dd = dd * -1;
  }
  return dd;
}

// Find closest barangay based on GPS coordinates
function findClosestBarangay(latitude, longitude) {
  // Validate if location is within Davao City bounds
  const davaoCityBounds = {
    north: 7.4,
    south: 6.8,
    east: 125.8,
    west: 125.0
  };
  
  if (latitude < davaoCityBounds.south || latitude > davaoCityBounds.north || 
      longitude < davaoCityBounds.west || longitude > davaoCityBounds.east) {
    return null; // Outside Davao City
  }
  
  // Find closest barangay
  let closestBarangay = null;
  let minDistance = Infinity;
  
  for (const [name, coords] of Object.entries(davaoCityBarangays)) {
    const distance = calculateDistance(latitude, longitude, coords.lat, coords.lng);
    
    if (distance < minDistance) {
      minDistance = distance;
      closestBarangay = name;
    }
  }
  
  return closestBarangay;
}

// Auto-select barangay in dropdown
function autoSelectBarangay(barangayName) {
  const barangaySelect = document.getElementById('barangay');
  if (!barangaySelect) return;
  
  console.log('üîç Attempting to select barangay:', barangayName);
  console.log('üìã Available registered barangays:', Array.from(barangaySelect.options).map(o => o.textContent));
  
  // Try to find exact match first
  let found = false;
  for (let option of barangaySelect.options) {
    if (option.textContent.trim() === barangayName.trim()) {
      barangaySelect.value = option.value;
      barangaySelect.dispatchEvent(new Event('change'));
      found = true;
      console.log('‚úÖ Barangay auto-selected:', barangayName);
      showLocationFeedback(`üìç Location detected: ${barangayName}`, 'success');
      break;
    }
  }
  
  // If not found, try case-insensitive and partial matching
  if (!found) {
    const lowerBarangay = barangayName.toLowerCase();
    for (let option of barangaySelect.options) {
      const optionText = option.textContent.trim().toLowerCase();
      if (optionText === lowerBarangay || optionText.includes(lowerBarangay) || lowerBarangay.includes(optionText)) {
        barangaySelect.value = option.value;
        barangaySelect.dispatchEvent(new Event('change'));
        found = true;
        console.log('‚úÖ Barangay auto-selected (fuzzy match):', option.textContent);
        showLocationFeedback(`üìç Location detected: ${option.textContent}`, 'success');
        break;
      }
    }
  }
  
  // If still not found, show appropriate message
  if (!found) {
    console.warn('‚ùå Barangay not found in registered list:', barangayName);
    
    // Check if it's in the full database (even without admin)
    if (davaoCityBarangays[barangayName]) {
      console.log('‚ö†Ô∏è Barangay found in full database but has no registered admin');
      showLocationFeedback(`üìç ${barangayName} detected! However, this barangay doesn't have a registered admin yet. Please select a nearby registered barangay from the list.`, 'warning');
    } else {
      showLocationFeedback(`üìç ${barangayName} is not a valid Davao City barangay. Please select a registered barangay from the list.`, 'error');
    }
  }
}

// Show location feedback to user
function showLocationFeedback(message, type) {
  // Create or update feedback element
  let feedbackElement = document.getElementById('locationFeedback');
  if (!feedbackElement) {
    feedbackElement = document.createElement('div');
    feedbackElement.id = 'locationFeedback';
    feedbackElement.style.cssText = `
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    `;
    
    // Insert after the image upload input
    const imageInput = document.getElementById('imageUpload');
    if (imageInput && imageInput.parentNode) {
      imageInput.parentNode.insertBefore(feedbackElement, imageInput.nextSibling);
    }
  }
  
  // Set message and styling based on type
  feedbackElement.textContent = message;
  feedbackElement.className = `location-feedback ${type}`;
  
  // Style based on type
  switch (type) {
    case 'success':
      feedbackElement.style.background = 'rgba(16, 185, 129, 0.1)';
      feedbackElement.style.color = '#10b981';
      feedbackElement.style.border = '1px solid rgba(16, 185, 129, 0.2)';
      break;
    case 'warning':
      feedbackElement.style.background = 'rgba(245, 158, 11, 0.1)';
      feedbackElement.style.color = '#f59e0b';
      feedbackElement.style.border = '1px solid rgba(245, 158, 11, 0.2)';
      break;
    case 'error':
      feedbackElement.style.background = 'rgba(239, 68, 68, 0.1)';
      feedbackElement.style.color = '#ef4444';
      feedbackElement.style.border = '1px solid rgba(239, 68, 68, 0.2)';
      break;
    case 'info':
      feedbackElement.style.background = 'rgba(59, 130, 246, 0.1)';
      feedbackElement.style.color = '#3b82f6';
      feedbackElement.style.border = '1px solid rgba(59, 130, 246, 0.2)';
      break;
    case 'processing':
      feedbackElement.style.background = 'rgba(156, 163, 175, 0.1)';
      feedbackElement.style.color = '#9ca3af';
      feedbackElement.style.border = '1px solid rgba(156, 163, 175, 0.2)';
      break;
  }
}

// Search functionality
function toggleBarangaySearch() {
  const modal = document.getElementById('searchModal');
  modal.style.display = 'flex';
  setTimeout(() => modal.classList.add('show'), 10);
  document.body.style.overflow = 'hidden';
  
  // Focus on search input
  setTimeout(() => {
    document.getElementById('searchInput').focus();
  }, 100);
  
  // Load all barangays for search
  loadAllBarangaysForSearch();
}

function closeSearchModal() {
  const modal = document.getElementById('searchModal');
  modal.classList.remove('show');
  setTimeout(() => {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }, 300);
  
  // Clear search
  document.getElementById('searchInput').value = '';
  selectedBarangay = null;
  document.getElementById('selectBtn').disabled = true;
}

function loadAllBarangaysForSearch() {
  // Use the same barangays that were loaded for the dropdown
  const barangaySelect = document.getElementById('barangay');
  allBarangays = [];
  
  for (let i = 1; i < barangaySelect.options.length; i++) { // Skip first option (placeholder)
    allBarangays.push(barangaySelect.options[i].value);
  }
  
  // Display all barangays initially
  displaySearchResults(allBarangays);
}

function displaySearchResults(barangays) {
  const resultsContainer = document.getElementById('searchResults');
  
  if (barangays.length === 0) {
    resultsContainer.innerHTML = '<div class="no-results">No barangays found</div>';
    return;
  }
  
  resultsContainer.innerHTML = '';
  barangays.forEach(barangay => {
    const item = document.createElement('div');
    item.className = 'search-result-item';
    item.textContent = barangay;
    item.onclick = () => selectSearchResult(item, barangay);
    resultsContainer.appendChild(item);
  });
}

function selectSearchResult(element, barangay) {
  // Remove previous selection
  document.querySelectorAll('.search-result-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  // Add selection to clicked item
  element.classList.add('selected');
  selectedBarangay = barangay;
  document.getElementById('selectBtn').disabled = false;
}

function selectBarangay() {
  if (selectedBarangay) {
    // Set the selected barangay in the dropdown
    const barangaySelect = document.getElementById('barangay');
    barangaySelect.value = selectedBarangay;
    
    // Close the search modal
    closeSearchModal();
  }
}

// Search input event listener
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      
      if (query === '') {
        displaySearchResults(allBarangays);
      } else {
        const filtered = allBarangays.filter(barangay => 
          barangay.toLowerCase().includes(query)
        );
        displaySearchResults(filtered);
      }
      
      // Clear selection when searching
      selectedBarangay = null;
      document.getElementById('selectBtn').disabled = true;
    });
  }
});

// Function to load all registered barangays with admins
async function loadRegisteredBarangays() {
  try {
    const response = await fetch('/api/barangays/registered/', {
      method: 'GET',
      credentials: 'same-origin'
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.success && data.barangays && data.barangays.length > 0) {
        const barangaySelect = document.getElementById('barangay');
        
        // Clear the loading option
        barangaySelect.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Barangay';
        barangaySelect.appendChild(defaultOption);
        
        // Add all registered barangays
        data.barangays.forEach(barangay => {
          const option = document.createElement('option');
          option.value = barangay;
          option.textContent = barangay;
          barangaySelect.appendChild(option);
        });
        
        // Enable the select
        barangaySelect.disabled = false;
        
        console.log('Registered barangays loaded:', data.barangays);
      } else {
        console.error('No registered barangays found');
        document.getElementById('barangay').innerHTML = '<option value="">No barangays available</option>';
      }
    } else {
      console.error('Failed to load registered barangays');
      document.getElementById('barangay').innerHTML = '<option value="">Failed to load barangays</option>';
    }
  } catch (error) {
    console.error('Error loading registered barangays:', error);
    document.getElementById('barangay').innerHTML = '<option value="">Error loading barangays</option>';
  }
}

document.getElementById('complaintType').addEventListener('change', function(){
  document.getElementById('otherIssueDiv').style.display = this.value === 'other' ? 'block' : 'none';
});

document.getElementById('complaintForm').addEventListener('submit', function(e){
  e.preventDefault();
  // Gather form data
  const barangay = document.getElementById('barangay').value;
  const complaintTypeSelect = document.getElementById('complaintType');
  let complaintType = complaintTypeSelect.value;
  if (complaintType === 'other') {
    complaintType = document.getElementById('otherIssue').value || 'Other';
  }
  const description = document.getElementById('description').value;
  const location = document.getElementById('location').value;

  // Handle image upload and send to backend
  const imageInput = document.getElementById('imageUpload');
  const file = imageInput.files[0];
  
  // Check file size (max 5MB)
  const maxFileSize = 5 * 1024 * 1024; // 5MB in bytes
  if (file && file.size > maxFileSize) {
    alert('File size is too large. Please select an image smaller than 5MB.');
    return;
  }
  
  if (file) {
    // Show compression loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Compressing image...';
    submitBtn.disabled = true;
    
    // Compress image before sending
    compressImage(file, function(compressedImageData) {
      saveToBackend(compressedImageData);
    });
  } else {
    saveToBackend(null);
  }

  function compressImage(file, callback) {
    const maxWidth = 800;
    const maxHeight = 600;
    const quality = 0.7;
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      // Calculate new dimensions
      let { width, height } = img;
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = (width * maxHeight) / height;
        height = maxHeight;
      }
      
      // Set canvas dimensions
      canvas.width = width;
      canvas.height = height;
      
      // Draw and compress image
      ctx.drawImage(img, 0, 0, width, height);
      const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
      
      console.log('Image compressed successfully');
      callback(compressedDataUrl);
    };
    
    img.onerror = function() {
      console.error('Error loading image for compression');
      // Fallback to original file
      const reader = new FileReader();
      reader.onload = function(evt) {
        callback(evt.target.result);
      };
      reader.readAsDataURL(file);
    };
    
    img.src = URL.createObjectURL(file);
  }

  function saveToBackend(imageData) {
    const requestData = {
      barangay: barangay,
      complaint_type: complaintType,
      description: description,
      location: location,
      image: imageData
    };
    
    console.log('Submitting complaint data:', requestData); // Debug logging
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;
    
    fetch('/api/complaints/create/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    })
    .then(async (res) => {
      console.log('Response status:', res.status); // Debug logging
      if (!res.ok) {
        const text = await res.text();
        console.error('Server error response:', text); // Debug logging
        throw new Error(text || 'Failed to submit complaint');
      }
      return res.json();
    })
    .then((data) => {
      console.log('Success response:', data); // Debug logging
      document.getElementById('trackingNumber').textContent = data.tracking_id;
      showNotification();
    })
    .catch((err) => {
      console.error('Error submitting complaint:', err); // Debug logging
      alert('Error: ' + err.message);
    })
    .finally(() => {
      // Reset button state
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });
  }
});

function showNotification() {
      const modal = document.getElementById('notificationModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    document.body.style.overflow = 'hidden';
}

function copyTrackingNumber() {
  const trackingNumber = document.getElementById('trackingNumber').textContent;
  navigator.clipboard.writeText(trackingNumber).then(function() {
    // Change button text temporarily to show success
    const copyBtn = document.querySelector('.copy-btn');
    const originalText = copyBtn.innerHTML;
    copyBtn.innerHTML = '<div class="copy-icon"></div>Copied!';
    copyBtn.style.background = 'rgba(16, 185, 129, 0.2)';
    copyBtn.style.borderColor = 'rgba(16, 185, 129, 0.4)';
    
    setTimeout(() => {
      copyBtn.innerHTML = originalText;
      copyBtn.style.background = 'rgba(255, 255, 255, 0.1)';
      copyBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
    }, 2000);
  }).catch(function(err) {
    console.error('Could not copy text: ', err);
  });
}

function closeNotification() {
  const modal = document.getElementById('notificationModal');
  modal.classList.remove('show');
  setTimeout(() => {
    modal.style.display = 'none';
    document.body.style.overflow = '';
    // Redirect to view transactions after closing notification
    window.location.href = 'user-view.html';
  }, 300);
}

// User Authentication Check - Only redirect if API call fails
async function checkUserAuth() {
  try {
    // Try to fetch user data from the server to verify session
    const response = await fetch('/api/user/check-auth/', {
      method: 'GET',
      credentials: 'same-origin'
    });
    
    if (response.status === 401) {
      // User is not authenticated, redirect to login
      window.location.href = '/index.html?show_login=true';
      return;
    }
    
    if (response.ok) {
      const userData = await response.json();
      // Check if user is an admin (admin should not access user pages)
      if (userData.role === 'admin') {
        window.location.href = '/index.html?show_login=true';
        return;
      }
      console.log('User authenticated:', userData.email);
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    // Don't redirect on network errors, let the user continue
  }
}

// Run authentication check when page loads
document.addEventListener('DOMContentLoaded', function() {
  checkUserAuth();
});
</script>
</body>
</html>
