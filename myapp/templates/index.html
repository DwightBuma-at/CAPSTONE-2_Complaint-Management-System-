{% load static %}
<!DOCTYPE html>
<!-- Updated: Admin signup form fixed -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CMS ‚Äî Complaint Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#9aa4bf;--text:#eaf0ff;--brand:#3b82f6;--brand-2:#22d3ee;--accent:#f59e0b;--ring:rgba(59,130,246,.35);--ok:#10b981;--danger:#ef4444;--shadow:0 10px 25px rgba(0,0,0,.35);--radius:18px;}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;padding-top:72px;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 600px at 20% -10%,rgba(34,211,238,.25),transparent 60%),radial-gradient(900px 500px at 90% 10%,rgba(59,130,246,.25),transparent 60%),var(--bg);color:var(--text);line-height:1.6;}
    /* Header */
    .nav{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      backdrop-filter: saturate(160%) blur(8px);
      -webkit-backdrop-filter: saturate(160%) blur(8px); /* For Safari support */
      background: linear-gradient(180deg, rgba(11,16,32,.95), rgba(11,16,32,.85));
      border-bottom: 1px solid rgba(255,255,255,.06);
      transition: all 0.3s ease;
      will-change: transform;
      width: 100%;
      box-sizing: border-box;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 20px}
    .nav__inner{display:flex;align-items:center;justify-content:space-between;height:72px;}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: conic-gradient(from 210deg, var(--brand), var(--brand-2), var(--brand));
      box-shadow: 0 6px 18px rgba(34,211,238,.35);
    }
    .brand span{font-weight:800;letter-spacing:.2px}
    .nav__inner{display:flex;align-items:center;justify-content:space-between}
    .nav__links{display:flex;gap:26px;align-items:center}
    .nav__links a{color:var(--muted);text-decoration:none;font-weight:600}
    .nav__links a:hover{color:#fff}
    .nav__auth{display:flex;gap:12px;align-items:center}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:46px;padding:0 18px;border:none;border-radius:14px;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color:#031026;font-weight:800;cursor:pointer;box-shadow: var(--shadow);
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.6);
      background: linear-gradient(90deg, #2563eb, #0891b2);
    }
    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 4px 15px rgba(59, 130, 246, 0.6);
    }
    .btn--ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      transition: all 0.2s ease;
    }
    .btn--ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    .btn--ghost:active {
      transform: translateY(0);
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
    }
    .btn--ghost:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    }
    .btn--small{height:36px;padding:0 14px;font-size:0.9rem}
    .hamburger{display:none;background:none;border:none;color:#fff;font-size:28px}
    /* Hero */
    .hero{padding:72px 0 48px;position:relative;overflow:hidden}
    .hero__grid{display:flex;flex-direction:column;align-items:center;text-align:center;max-width:800px;margin:0 auto;position:relative;z-index:2}
    .kicker{display:inline-block;padding:8px 16px;border-radius:999px;background:linear-gradient(135deg,rgba(34,211,238,.2),rgba(59,130,246,.2));color:#b7f9ff;font-weight:700;font-size:.85rem;border:1px solid rgba(34,211,238,.3);backdrop-filter:blur(10px);animation:float 3s ease-in-out infinite}
    h1{font-size:clamp(2rem,5vw,3.5rem);line-height:1.12;margin:.6rem 0;background:linear-gradient(135deg,#fff,#b7f9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:glow 2s ease-in-out infinite alternate}
    .lead{color:#c6d0ea;max-width:60ch;font-size:1.1rem;line-height:1.6}
    .hero__cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:32px}
    
    /* Animated background elements */
    .hero::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 20%,rgba(59,130,246,.1) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(34,211,238,.1) 0%,transparent 50%);animation:backgroundShift 8s ease-in-out infinite}
    .hero::after{content:'';position:absolute;top:50%;left:50%;width:300px;height:300px;background:radial-gradient(circle,rgba(59,130,246,.05) 0%,transparent 70%);border-radius:50%;transform:translate(-50%,-50%);animation:pulse 4s ease-in-out infinite}
    
    /* Feature cards */
    .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:24px;margin:48px 0;max-width:1000px;margin-left:auto;margin-right:auto}
    .feature-card{background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px;text-align:center;transition:all 0.3s ease;backdrop-filter:blur(10px)}
    .feature-card:hover{transform:translateY(-4px);border-color:rgba(59,130,246,.3);box-shadow:0 8px 32px rgba(59,130,246,.1)}
    .feature-icon{font-size:2.5rem;margin-bottom:16px;display:block}
    .feature-title{font-size:1.2rem;font-weight:700;margin-bottom:8px;color:#fff}
    .feature-desc{color:#9aa4bf;font-size:.9rem;line-height:1.5}
    
    /* Animations */
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes glow{0%{text-shadow:0 0 20px rgba(59,130,246,.3)}100%{text-shadow:0 0 30px rgba(59,130,246,.5),0 0 40px rgba(34,211,238,.3)}}
    @keyframes backgroundShift{0%,100%{opacity:1}50%{opacity:0.8}}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.5}50%{transform:translate(-50%,-50%) scale(1.1);opacity:0.3}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .screen{aspect-ratio:16/10}
    .screen__inner{height:100%;padding:18px}
    .screen__window{
      height:100%;border-radius:14px;background:
      linear-gradient(120deg, rgba(59,130,246,.15), rgba(34,211,238,.08));
      border:1px solid rgba(255,255,255,.08);position:relative;overflow:hidden;
    }
    .pulse{
      position:absolute;inset:auto 24px 24px auto;padding:6px 10px;border-radius:10px;
      background:#071226;color:#b9d8ff;border:1px solid rgba(59,130,246,.35);
      animation:float 6s ease-in-out infinite;
    }
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .muted{color:var(--muted)}
    .footer{
      padding:48px 0; color:var(--muted); font-size:.95rem;border-top:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,transparent,rgba(11,16,32,.3))
    }
    .footer-content{display:flex;align-items:center;justify-content:center;gap:20px;flex-wrap:wrap;text-align:center}
    .footer-links{display:flex;gap:24px;align-items:center;flex-wrap:wrap}
    .footer-links a{color:var(--muted);text-decoration:none;transition:color 0.2s ease}
    .footer-links a:hover{color:#fff}
    .footer-divider{width:1px;height:16px;background:rgba(255,255,255,.2)}
    /* Utilities */
    .hidden{display:none}
    /* Responsive */
    @media (max-width: 980px){
      .hero__grid{max-width:100%;padding:0 20px}
      .nav__links,.nav__auth{display:none}
      .hamburger{display:block}
      .mobile{position:absolute;left:0;right:0;top:72px;background:#0b1226;padding:14px;border-bottom:1px solid rgba(255,255,255,.08)}
      .mobile a{display:block;padding:10px 0;color:#d8e1ff;text-decoration:none;border-bottom:1px dashed rgba(255,255,255,.08)}
      .mobile .btn{width:100%;margin-top:10px}
      .features{grid-template-columns:1fr;gap:16px;margin:32px 0}
      .feature-card{padding:20px}
      .hero__cta{flex-direction:column;align-items:center;gap:12px}
      .hero__cta .btn{width:100%;max-width:280px}
      .footer-content{flex-direction:column;gap:16px}
      .footer-links{justify-content:center}
    }
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      padding: 0;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .modal.show .modal-content {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 24px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
      color: var(--text);
      font-size: 1.5rem;
      font-weight: 700;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    .modal-form {
      padding: 0 24px 24px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .form-group input {
      width: 100%;
      height: 46px;
      padding: 0 16px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      background: rgba(11, 18, 38, 0.8);
      color: var(--text);
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    /* Password toggle styles */
    .password-input-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .password-input-container input {
      padding-right: 50px; /* Make room for the toggle button */
    }
    
    /* Hide browser default password toggle icons */
    .password-input-container input[type="password"]::-webkit-textfield-decoration-container {
      display: none !important;
    }
    
    .password-input-container input[type="password"]::-webkit-credentials-auto-fill-button {
      display: none !important;
    }
    
    .password-input-container input[type="password"]::-webkit-strong-password-auto-fill-button {
      display: none !important;
    }
    
    .password-input-container input[type="password"]::-webkit-credentials-auto-fill-icon {
      display: none !important;
    }
    
    /* Hide any default browser eye icons */
    .password-input-container input[type="password"]::-ms-reveal {
      display: none !important;
    }
    
    .password-input-container input[type="password"]::-ms-clear {
      display: none !important;
    }
    
    /* Additional browser-specific hiding */
    .password-input-container input[type="password"]::-webkit-input-placeholder {
      color: transparent;
    }
    
    /* Force hide any browser default password icons */
    .password-input-container input[type="password"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .password-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .password-toggle:active {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .eye-icon {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      transition: color 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .password-toggle:hover .eye-icon {
      color: var(--text);
    }
    
    .password-toggle.active .eye-icon {
      color: var(--brand);
    }
    
    /* Barangay validation styles */
    .barangay-error {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
      animation: fadeIn 0.3s ease-in;
    }
    
    .barangay-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideDown 0.2s ease-out;
    }
    
    .barangay-dropdown div {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
      color: #333;
    }
    
    .barangay-dropdown div:hover {
      background-color: #f5f5f5;
    }
    
    .barangay-dropdown div:last-child {
      border-bottom: none;
    }
    
    .form-help {
      display: block;
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.4;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-options {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.9rem;
      cursor: pointer;
    }
    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
    }
    .forgot-link, .terms-link {
      color: var(--brand);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s ease;
    }
    .forgot-link:hover, .terms-link:hover {
      color: var(--brand-2);
    }
    .btn--full {
      width: 100%;
      margin-bottom: 20px;
    }
    .modal-switch {
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0;
    }
    .modal-switch a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
    }
    .modal-switch a:hover {
      color: var(--brand-2);
    }
    /* OTP Verification Styles */
    .otp-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .otp-header h3 {
      margin: 0 0 8px 0;
      color: #fff;
      font-size: 1.25rem;
    }
    .otp-header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    #otpEmailDisplay {
      color: #fff;
      font-weight: 600;
    }
    .otp-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .otp-actions .btn {
      flex: 1;
      font-size: 0.85rem;
    }
    .otp-timer {
      text-align: center;
      margin-top: 16px;
      color: var(--muted);
      font-size: 0.85rem;
    }
    #otpCode {
      text-align: center;
      font-size: 1.2rem;
      letter-spacing: 2px;
      font-family: monospace;
    }
    /* Login OTP specific styles */
    #loginOtpCode {
      text-align: center;
      font-size: 1.2rem;
      letter-spacing: 2px;
      font-family: monospace;
    }
    #loginOtpEmailDisplay {
      color: #fff;
      font-weight: 600;
    }
    /* Modal responsive */
    @media (max-width: 480px) {
      .modal-content {
        width: 95%;
        margin: 20px;
      }
      .modal-header {
        padding: 20px 20px 0;
      }
      .modal-form {
        padding: 0 20px 20px;
      }
    }
    /* Notification Modal Styles */
    .notification-content {
      max-width: 450px;
      padding: 0;
    }
    .notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 24px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    .notification-icon {
      font-size: 2rem;
      margin-right: 16px;
    }
    .notification-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.3rem;
      font-weight: 700;
      flex: 1;
    }
    .notification-body {
      padding: 0 24px 20px;
    }
    .notification-body p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
      text-align: center;
    }
    .notification-actions {
      padding: 0 24px 24px;
    }
    .notification-actions .btn {
      margin-top: 0;
    }
    /* Modal responsive */
    @media (max-width: 480px) {
      .otp-actions {
        flex-direction: column;
      }
    }
    /* Role Toggle Styles */
    .role-toggle {
      padding: 0 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    .toggle-container {
      display: flex;
      background: rgba(11, 18, 38, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 4px;
      gap: 4px;
    }
    .toggle-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .toggle-btn.active {
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #031026;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    .toggle-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }
    .toggle-btn:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    /* Admin Message Styles */
    #adminMessage p {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0;
      padding: 12px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      border-left: 3px solid var(--brand);
      line-height: 1.5;
    }
    /* Admin Access Key Field Styles */
    #adminAccessKey {
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
      text-align: center;
      font-weight: 600;
    }
    /* Input with button layout */
    .input-with-button {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    .input-with-button input {
      flex: 1;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      color: #000000 !important; /* Black text color */
      resize: none; /* Prevent resizing */
      min-width: 0; /* Prevent flex growing */
      width: 100%; /* Fixed width */
      max-width: none; /* Allow natural width */
    }
    
    /* Specific styling for barangay input field */
    #signupBarangay {
      color: #000000 !important; /* Ensure black text */
      background: #ffffff !important; /* White background for better contrast */
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      resize: none !important; /* Prevent any resizing */
      width: 100% !important; /* Fixed width */
      min-width: 200px; /* Minimum width */
      max-width: 100%; /* Maximum width */
      height: 46px !important; /* Fixed height */
      box-sizing: border-box !important; /* Include padding in width calculation */
      overflow: hidden !important; /* Prevent content overflow */
    }
    .input-with-button .btn {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      white-space: nowrap;
      min-width: 80px;
    }
    .form-help {
      display: block;
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.4;
    }
    
    /* Barangay error message styling */
    .barangay-error {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      width: 100%;
      clear: both;
    }
  </style>
</head>
<body>
<header class="nav">
  <div class="wrap nav__inner">
    <a class="brand" href="#top" aria-label="CMS Home"><div class="logo" aria-hidden="true"></div><span>CMS</span></a>
         <nav class="nav__links" aria-label="Main">
     </nav>
    <div class="nav__auth">
      <button class="btn btn--ghost btn--small" onclick="openModal('loginModal')" style="background:transparent;border:1px solid rgba(255,255,255,.15);color:#fff;">Login</button>
      <button class="btn btn--small" onclick="openModal('signupModal')" style="background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#031026;">Sign Up</button>
    </div>
    <button class="hamburger" aria-label="Menu" id="menuBtn">‚ò∞</button>
  </div>
     <div class="mobile hidden" id="mobileMenu">
     <button class="btn btn--ghost" onclick="openModal('loginModal');toggleMenu(false)" style="background:transparent;border:1px solid rgba(255,255,255,.15);color:#fff;">Login</button><button class="btn" onclick="openModal('signupModal');toggleMenu(false)" style="background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#031026;">Sign Up</button>
   </div>
</header>
<!-- Modals -->
<!-- Login Modal -->
<div id="loginModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Login</h2>
      <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
    </div>
    <!-- Role Toggle -->
    <div class="role-toggle">
      <div class="toggle-container">
        <button class="toggle-btn active" data-role="user" onclick="toggleRole('user', 'login')">User</button>
        <button class="toggle-btn" data-role="admin" onclick="toggleRole('admin', 'login')">Admin</button>
      </div>
    </div>
    <!-- Step 1: Initial Login Form -->
    <form class="modal-form" id="loginForm">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" name="email" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <div class="password-input-container">
          <input type="password" id="loginPassword" name="password" required>
          <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
            <span class="eye-icon">Show</span>
          </button>
        </div>
      </div>
      
      <!-- Admin Name Field - Only shown for admin login -->
      <div class="form-group" id="adminNameField" style="display: none;">
        <label for="adminLoginName">Logged in as:</label>
        <input type="text" id="adminLoginName" name="adminName" placeholder="Enter your name">
      </div>

      <div class="form-options">
        <label class="checkbox-label">
          <input type="checkbox" name="remember">
          <span>Remember me</span>
        </label>
        <a href="#" class="forgot-link">Forgot password?</a>
      </div>
      <button type="submit" class="btn btn--full">Send Verification Code</button>
      <p class="modal-switch">
        Don't have an account?
        <a href="#" onclick="switchModal('loginModal', 'signupModal')">Sign up</a>
      </p>
    </form>
    <!-- Step 2: Login OTP Verification Form -->
    <form class="modal-form hidden" id="loginOtpForm">
      <div class="otp-header">
        <h3>Verify Your Email</h3>
        <p>We've sent a 6-digit verification code to <span id="loginOtpEmailDisplay"></span></p>
      </div>
      <div class="form-group">
        <label for="loginOtpCode">Verification Code</label>
        <input type="text" id="loginOtpCode" name="otp" maxlength="6" placeholder="Enter 6-digit code" required>
      </div>
      <div class="otp-actions">
        <button type="button" class="btn btn--ghost" onclick="resendLoginOTP()">Resend Code</button>
        <button type="button" class="btn btn--ghost" onclick="changeLoginEmail()">Change Email</button>
      </div>
      <button type="submit" class="btn btn--full">Verify & Login</button>
      <p class="otp-timer">Resend available in <span id="loginResendTimer">60</span>s</p>
    </form>
  </div>
</div>
<!-- Signup Modal -->
<div id="signupModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Sign Up as User</h2>
      <button class="modal-close" onclick="closeModal('signupModal')">&times;</button>
    </div>
    <!-- Step 1: Initial Signup Form -->
    <form class="modal-form" id="signupForm">
      <div class="form-group">
        <label for="signupName">Full Name</label>
        <input type="text" id="signupName" name="name" required>
      </div>
      <div class="form-group">
        <label for="signupEmail">Email</label>
        <input type="email" id="signupEmail" name="email" required>
      </div>
      <div class="form-group">
        <label for="signupBarangay">Barangay</label>
        <div class="input-with-button">
          <input type="text" id="signupBarangay" name="barangay" required>
          <button type="button" class="btn btn--ghost btn--small" onclick="locateBarangay()" id="locateBarangayBtn">
            <span id="locateBtnText">üìç Locate</span>
          </button>
        </div>
        <small class="form-help">Click "Locate" to automatically detect your barangay using GPS</small>
        <small class="form-help" style="color: #6b7280; margin-top: 4px; display: block;">
          Only official Davao City barangays (182 total) are accepted. 
          <button type="button" onclick="showBarangayList()" style="background: none; border: none; color: #3b82f6; text-decoration: underline; cursor: pointer; font-size: inherit;">View all barangays</button>
        </small>
      </div>
      <div class="form-group">
        <label for="signupPassword">Password</label>
        <div class="password-input-container">
          <input type="password" id="signupPassword" name="password" required>
          <button type="button" class="password-toggle" onclick="togglePassword('signupPassword')">
            <span class="eye-icon">Show</span>
          </button>
        </div>
      </div>
      <div class="form-group">
        <label for="signupConfirmPassword">Confirm Password</label>
        <div class="password-input-container">
          <input type="password" id="signupConfirmPassword" name="confirmPassword" required>
          <button type="button" class="password-toggle" onclick="togglePassword('signupConfirmPassword')">
            <span class="eye-icon">Show</span>
          </button>
        </div>
      </div>
      <div class="form-options">
        <label class="checkbox-label">
          <input type="checkbox" name="terms" required>
          <span>I agree to the <a href="#" class="terms-link">Terms of Service</a></span>
        </label>
      </div>
      <button type="submit" class="btn btn--full">Send Verification Code</button>
      <p class="modal-switch">
        Already have an account?
        <a href="#" onclick="switchModal('signupModal', 'loginModal')">Login</a>
      </p>
    </form>
    <!-- Step 2: OTP Verification Form -->
    <form class="modal-form hidden" id="otpForm">
      <div class="otp-header">
        <h3>Verify Your Email</h3>
        <p>We've sent a 6-digit verification code to <span id="otpEmailDisplay"></span></p>
      </div>
      <div class="form-group">
        <label for="otpCode">Verification Code</label>
        <input type="text" id="otpCode" name="otp" maxlength="6" placeholder="Enter 6-digit code" required>
      </div>
      <div class="otp-actions">
        <button type="button" class="btn btn--ghost" onclick="resendOTP()">Resend Code</button>
        <button type="button" class="btn btn--ghost" onclick="changeEmail()">Change Email</button>
      </div>
      <button type="submit" class="btn btn--full">Verify & Create Account</button>
      <p class="otp-timer">Resend available in <span id="resendTimer">60</span>s</p>
    </form>
  </div>
</div>
<!-- Custom Notification Modal -->
<div id="notificationModal" class="modal hidden">
  <div class="modal-content notification-content">
    <div class="notification-header">
      <div class="notification-icon" id="notificationIcon">‚úÖ</div>
      <h3 id="notificationTitle">Success</h3>
      <button class="modal-close" onclick="closeNotification()">&times;</button>
    </div>
    <div class="notification-body">
      <p id="notificationMessage">Operation completed successfully.</p>
    </div>
    <div class="notification-actions">
      <button class="btn btn--full" onclick="closeNotification()">OK</button>
    </div>
  </div>
</div>
<!-- Hero -->
<main id="top" class="wrap hero">
      <div class="hero__grid">
      <span class="kicker">Barangay-ready ‚Ä¢ Secure ‚Ä¢ Fast</span>
      <h1>Report ‚Ä¢ Track ‚Ä¢ Resolve<br/></h1>
      <p class="lead">
        The Complaint Management System helps residents submit reports in seconds, while giving local offices a crystal‚Äëclear view of every case from intake to resolution.
      </p>
      <div class="hero__cta">
        <button class="btn" onclick="openModal('signupModal')">Get Started</button>
        <button class="btn btn--ghost" onclick="openModal('loginModal')">Sign In</button>
      </div>
    </div>
</main>

<!-- Features Section -->
<section class="wrap" style="padding:48px 0;">
  <div class="features">
    <div class="feature-card">
      <span class="feature-icon">üì±</span>
      <h3 class="feature-title">Easy Reporting</h3>
      <p class="feature-desc">Submit complaints in seconds with our intuitive mobile-friendly interface. Upload photos and provide detailed descriptions.</p>
    </div>
    <div class="feature-card">
      <span class="feature-icon">üìä</span>
      <h3 class="feature-title">Real-time Tracking</h3>
      <p class="feature-desc">Track your complaint status in real-time. Get instant notifications when your case is updated or resolved.</p>
    </div>
    <div class="feature-card">
      <span class="feature-icon">üîí</span>
      <h3 class="feature-title">Secure & Private</h3>
      <p class="feature-desc">Your data is protected with enterprise-grade security. All communications are encrypted and confidential.</p>
    </div>
    <div class="feature-card">
      <span class="feature-icon">‚ö°</span>
      <h3 class="feature-title">Fast Resolution</h3>
      <p class="feature-desc">Streamlined workflow ensures faster response times. Barangay officials can prioritize and resolve issues efficiently.</p>
    </div>
    <div class="feature-card">
      <span class="feature-icon">üí¨</span>
      <h3 class="feature-title">Direct Communication</h3>
      <p class="feature-desc">Chat directly with barangay officials. Ask questions, provide updates, and get immediate responses.</p>
    </div>
    <div class="feature-card">
      <span class="feature-icon">üèõÔ∏è</span>
      <h3 class="feature-title">Barangay Management</h3>
      <p class="feature-desc">Dedicated admin dashboard for barangay officials to manage complaints, track progress, and communicate with residents effectively.</p>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="wrap footer">
  <div class="footer-content">
    <div>¬© <span id="year"></span> CMS. All rights reserved.</div>
    <div class="footer-divider"></div>
    <div class="footer-links">
      <a href="#" onclick="openModal('loginModal')">Login</a>
      <a href="#" onclick="openModal('signupModal')">Sign Up</a>
    </div>
  </div>
</footer>
<!-- Place your script here, just before </body> -->
<script>
    // Smooth scroll helper
    function scrollToId(id){
      const el = document.getElementById(id);
      if(!el) return;
      const y = el.getBoundingClientRect().top + window.scrollY - 70;
      window.scrollTo({top:y, behavior:'smooth'});
    }
    // Mobile menu
    const menuBtn = document.getElementById('menuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    function toggleMenu(show){
      const isOpen = !mobileMenu.classList.contains('hidden');
      const next = (typeof show === 'boolean') ? show : !isOpen;
      mobileMenu.classList.toggle('hidden', !next);
      menuBtn.setAttribute('aria-expanded', String(next));
    }
    menuBtn.addEventListener('click', () => toggleMenu());
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();
    // Subtle link focus rings
    document.addEventListener('keydown', e=>{
      if(e.key === 'Tab'){ document.body.style.outline = '2px solid var(--ring)'; setTimeout(()=>document.body.style.outline='none',300)}
    });
    // Modal functionality
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('hidden');
        // Use setTimeout to ensure the modal is visible before adding the show class
        setTimeout(() => {
          modal.classList.add('show');
        }, 10);
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        // Reset signup form fields when opening signup modal
        if (modalId === 'signupModal') {
          const signupForm = document.getElementById('signupForm');
          const nameField = signupForm.querySelector('#signupName').closest('.form-group');
          const systemActivationKeyField = signupForm.querySelector('#systemActivationKey')?.closest('.form-group');
          const adminAccessKeyField = signupForm.querySelector('#adminAccessKey')?.closest('.form-group');
          const adminMessage = signupForm.querySelector('#adminMessage');
          // Reset to user form by default
          nameField.style.display = 'block';
          if (systemActivationKeyField) {
            systemActivationKeyField.style.display = 'none';
          }
          if (adminAccessKeyField) {
            adminAccessKeyField.style.display = 'none';
          }
          if (adminMessage) {
            adminMessage.style.display = 'none';
          }
        }
      }
    }
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 300);
        document.body.style.overflow = ''; // Restore scrolling
      }
    }
    function switchModal(closeModalId, openModalId) {
      closeModal(closeModalId);
      setTimeout(() => {
        openModal(openModalId);
        // Reset role toggle to default (user) when switching modals
        if (openModalId === 'loginModal') {
          toggleRole('user', 'login');
        } else if (openModalId === 'signupModal') {
          toggleRole('user', 'signup');
        }
      }, 350);
    }
    // Notification Modal Functions
    function showNotification(message, type = 'success') {
      const modal = document.getElementById('notificationModal');
      const icon = document.getElementById('notificationIcon');
      const title = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');
      // Set content based on type
      if (type === 'success') {
        icon.textContent = '‚úÖ';
        title.textContent = 'Success';
        title.style.color = 'var(--ok)';
      } else if (type === 'error') {
        icon.textContent = '‚ùå';
        title.textContent = 'Error';
        title.style.color = 'var(--danger)';
      } else if (type === 'info') {
        icon.textContent = '‚ÑπÔ∏è';
        title.textContent = 'Information';
        title.style.color = 'var(--brand)';
      }
      messageEl.textContent = message;
      // Show the notification
      openModal('notificationModal');
    }
    function closeNotification() {
      closeModal('notificationModal');
    }
    // Modals now only close via the X button
    // Removed automatic closing on outside click and Escape key
    // Handle form submissions
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const email = formData.get('email');
      const password = formData.get('password');
      const remember = formData.get('remember');
      const adminName = formData.get('adminName');
      const role = window.currentLoginRole || 'user';
      
      // Store login data for later use (include adminName for admin logins)
      window.loginData = { email, password, remember, role, adminName };
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Sending...';
      submitBtn.disabled = true;
      
      try {
        if (role === 'user') {
          // User login - send to API
          const response = await fetch('/api/user/login/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: email,
              password: password
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Show OTP form for user login
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('loginOtpForm').classList.remove('hidden');
            
            const otpHeader = document.querySelector('#loginOtpForm .otp-header');
            const otpLabel = document.querySelector('label[for="loginOtpCode"]');
            const otpInput = document.getElementById('loginOtpCode');
            
            otpHeader.style.display = 'block';
            document.getElementById('loginOtpEmailDisplay').textContent = email;
            if (otpLabel) otpLabel.textContent = 'Verification Code';
            if (otpInput) {
              otpInput.placeholder = 'Enter 6-digit code';
              otpInput.setAttribute('inputmode','numeric');
              otpInput.setAttribute('pattern','[0-9]{6}');
            }
            
            // Hide role toggle during OTP verification
            document.querySelector('#loginModal .role-toggle').style.display = 'none';
            // Start OTP timer
            startLoginOTPTimer();
            
            showNotification(data.message, 'success');
          } else {
            showNotification(data.error || 'Login failed', 'error');
          }
        } else {
          // Admin login - send to API
          const response = await fetch('/api/admin/login/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: email,
              password: password
            })
          });

          const data = await response.json();

          if (data.success) {
            // Show access key form for admin (loginOtpForm is repurposed)
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('loginOtpForm').classList.remove('hidden');

            const otpHeader = document.querySelector('#loginOtpForm .otp-header');
            const otpLabel = document.querySelector('label[for="loginOtpCode"]');
            const otpInput = document.getElementById('loginOtpCode');

            if (otpHeader) {
              otpHeader.style.display = 'none'; // Hide OTP header for access key
            }
            if (otpLabel) otpLabel.textContent = '6-digit Admin Access Key';
            if (otpInput) {
              otpInput.placeholder = 'Enter 6-digit admin key';
              otpInput.setAttribute('inputmode','numeric');
              otpInput.setAttribute('pattern','[0-9]{6}');
            }

            // Hide role toggle during access key verification
            document.querySelector('#loginModal .role-toggle').style.display = 'none';

            showNotification(data.message, 'success');
          } else {
            showNotification(data.error || 'Login failed', 'error');
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        showNotification('Network error. Please try again.', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      // Also try to get values directly from form elements as backup
      const name = formData.get('name') || e.target.querySelector('#signupName')?.value || '';
      const email = formData.get('email') || e.target.querySelector('#signupEmail')?.value || '';
      const barangay = formData.get('barangay') || e.target.querySelector('#signupBarangay')?.value || '';
      const password = formData.get('password') || e.target.querySelector('#signupPassword')?.value || '';
      const confirmPassword = formData.get('confirmPassword') || e.target.querySelector('#signupConfirmPassword')?.value || '';
      const terms = formData.get('terms');
      const systemActivationKey = formData.get('systemActivationKey');
      const adminAccessKey = formData.get('adminAccessKey');
      const role = 'user'; // Always user for signup in index.html
      
      // Debug logging
      console.log('Form data collected:', { name, email, barangay, password: password ? '***' : 'empty', confirmPassword: confirmPassword ? '***' : 'empty', role });
      
      // Validate required fields for user
      if (!name || !email || !barangay || !password || !confirmPassword) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      // Validate barangay is part of Davao City
      const barangayInput = e.target.querySelector('#signupBarangay');
      console.log('Validating barangay:', barangay);
      if (!validateBarangayField(barangayInput)) {
        console.log('Barangay validation failed for:', barangay);
        showNotification('Please enter a valid Davao City barangay from the official 182 barangays', 'error');
        return;
      }
      console.log('Barangay validation passed for:', barangay);
      
      // Validate passwords match
      if (password !== confirmPassword) {
        showNotification('Passwords do not match!', 'error');
        return;
      }
      console.log('Proceeding with user registration for role:', role);
      console.log('Sending data to API:', { full_name: name, email, barangay, password: password ? '***' : 'empty', confirm_password: confirmPassword ? '***' : 'empty' });
      
      try {
        const response = await fetch('/api/user/send-verification/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            full_name: name,
            email: email,
            barangay: barangay,
            password: password,
            confirm_password: confirmPassword
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Store signup data for later use
          window.signupData = { name, email, barangay, password, terms, role };
          // Show OTP form
          document.getElementById('signupForm').classList.add('hidden');
          document.getElementById('otpForm').classList.remove('hidden');
          document.getElementById('otpEmailDisplay').textContent = email;
          // Start OTP timer
          startOTPTimer();
          showNotification(data.message, 'success');
        } else {
          console.log('API Error Response:', data);
          showNotification(data.error || 'Failed to send verification code', 'error');
        }
      } catch (error) {
        console.error('Error sending verification code:', error);
        showNotification('Network error. Please try again.', 'error');
      }
    });
    // OTP form submission
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const otpCode = document.getElementById('otpCode').value;
      const role = 'user'; // Always user for signup in index.html
        try {
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Verifying...';
          submitBtn.disabled = true;
          
          const response = await fetch('/api/user/verify-email/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              full_name: window.signupData.name,
              email: window.signupData.email,
              barangay: window.signupData.barangay,
              password: window.signupData.password,
              otp_code: otpCode
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            submitBtn.textContent = 'Account Created!';
            setTimeout(() => {
              // Reset forms and close modal
              document.getElementById('signupForm').reset();
              document.getElementById('otpForm').reset();
              // Reset form field visibility after form reset
              const signupForm = document.getElementById('signupForm');
              const nameField = signupForm.querySelector('#signupName').closest('.form-group');
              const systemActivationKeyField = signupForm.querySelector('#systemActivationKey')?.closest('.form-group');
              const adminAccessKeyField = signupForm.querySelector('#adminAccessKey')?.closest('.form-group');
              const adminMessage = signupForm.querySelector('#adminMessage');
              // Reset to user form by default
              nameField.style.display = 'block';
              if (systemActivationKeyField) {
                systemActivationKeyField.style.display = 'none';
              }
              if (adminAccessKeyField) {
                adminAccessKeyField.style.display = 'none';
              }
              if (adminMessage) {
                adminMessage.style.display = 'none';
              }
              document.getElementById('signupForm').classList.remove('hidden');
              document.getElementById('otpForm').classList.add('hidden');
              // Show role toggle again
              document.querySelector('#signupModal .role-toggle').style.display = 'block';
              closeModal('signupModal');
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
              // Store user data in localStorage before clearing
              if (window.signupData) {
                localStorage.setItem('userData', JSON.stringify(window.signupData));
              }
              // Clear stored data
              delete window.signupData;
              console.log('Account created successfully as:', role);
              showNotification(data.message, 'success');
            }, 1000);
          } else {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            showNotification(data.error || 'Invalid verification code', 'error');
            document.getElementById('otpCode').value = '';
            document.getElementById('otpCode').focus();
          }
        } catch (error) {
          console.error('Error verifying OTP:', error);
          const submitBtn = e.target.querySelector('button[type="submit"]');
          submitBtn.textContent = 'Verify & Create Account';
          submitBtn.disabled = false;
          showNotification('Network error. Please try again.', 'error');
        }
    });
    // Login OTP form submission
    document.getElementById('loginOtpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const otpCode = document.getElementById('loginOtpCode').value;
      const role = window.currentLoginRole || 'user';
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Verifying...';
      submitBtn.disabled = true;
      
      try {
        if (role === 'user') {
          // User login OTP verification - send to API
          const response = await fetch('/api/user/verify-login-otp/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: window.loginData.email,
              otp_code: otpCode
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Login successful
            submitBtn.textContent = 'Login Successful!';
            
            // Store user data in localStorage
            const userData = {
              name: data.user.full_name,
              email: data.user.email,
              barangay: data.user.barangay,
              role: role
            };
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // Reset forms and close modal
            document.getElementById('loginForm').reset();
            document.getElementById('loginOtpForm').reset();
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('loginOtpForm').classList.add('hidden');
            // Show role toggle again
            document.querySelector('#loginModal .role-toggle').style.display = 'block';
            closeModal('loginModal');
            
            // Clear stored data
            delete window.loginData;
            
            showNotification('Login successful! Redirecting to dashboard...', 'success');
            
            setTimeout(() => {
              // Redirect to user dashboard
              window.location.href = data.redirect || '/user.html';
            }, 1000);
          } else {
            showNotification(data.error || 'Invalid verification code', 'error');
            document.getElementById('loginOtpCode').value = '';
            document.getElementById('loginOtpCode').focus();
          }
        } else {
          // Admin login - verify access key with API
          const response = await fetch('/api/admin/verify-access-key/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: window.loginData.email,
              access_key: otpCode,
              admin_name: window.loginData.adminName
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Login successful
            submitBtn.textContent = 'Login Successful!';
            
            // Store admin data in localStorage
            const adminData = {
              name: data.user.username,
              email: data.user.email,
              barangay: data.user.barangay,
              role: role
            };
            localStorage.setItem('userData', JSON.stringify(adminData));
            
            // Reset forms and close modal
            document.getElementById('loginForm').reset();
            document.getElementById('loginOtpForm').reset();
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('loginOtpForm').classList.add('hidden');
            // Show role toggle again
            document.querySelector('#loginModal .role-toggle').style.display = 'block';
            closeModal('loginModal');
            
            // Clear stored data
            delete window.loginData;
            
            showNotification('Admin login successful! Redirecting to dashboard...', 'success');
            
            setTimeout(() => {
              // Redirect to admin dashboard
              window.location.href = data.redirect || '/admin-dashboard.html';
            }, 1000);
          } else {
            showNotification(data.error || 'Invalid admin access key', 'error');
            document.getElementById('loginOtpCode').value = '';
            document.getElementById('loginOtpCode').focus();
          }
        }
      } catch (error) {
        console.error('Login OTP verification error:', error);
        showNotification('Network error. Please try again.', 'error');
      } finally {
        if (submitBtn.textContent !== 'Login Successful!') {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
    });
    // OTP Timer functionality
    let otpTimer;
    let otpTimeLeft = 60;
    function startOTPTimer() {
      otpTimeLeft = 60;
      const timerDisplay = document.getElementById('resendTimer');
      const resendBtn = document.querySelector('.otp-actions .btn:first-child');
      resendBtn.disabled = true;
      resendBtn.style.opacity = '0.5';
      otpTimer = setInterval(() => {
        otpTimeLeft--;
        timerDisplay.textContent = otpTimeLeft;
        if (otpTimeLeft <= 0) {
          clearInterval(otpTimer);
          resendBtn.disabled = false;
          resendBtn.style.opacity = '1';
          timerDisplay.textContent = '0';
        }
      }, 1000);
    }
    // Resend OTP function
    async function resendOTP() {
      if (otpTimeLeft > 0) return;
      
      if (window.signupData && window.signupData.role === 'user') {
        try {
          const response = await fetch('/api/user/resend-verification/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: window.signupData.email
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showNotification(data.message, 'success');
            startOTPTimer();
          } else {
            showNotification(data.error || 'Failed to resend verification code', 'error');
          }
        } catch (error) {
          console.error('Error resending OTP:', error);
          showNotification('Network error. Please try again.', 'error');
        }
      } else if (window.signupData && window.signupData.role === 'admin') {
        // For admin, use the old demo flow
      console.log('OTP resent to:', window.signupData?.email);
      showNotification('Verification code resent to your email!', 'info');
      startOTPTimer();
      } else {
        showNotification('No signup data found. Please try signing up again.', 'error');
      }
    }
    // Change email function
    function changeEmail() {
      // Go back to signup form
      document.getElementById('otpForm').classList.add('hidden');
      document.getElementById('signupForm').classList.remove('hidden');
      // Show role toggle again
      document.querySelector('#signupModal .role-toggle').style.display = 'block';
      // Clear OTP form
      document.getElementById('otpForm').reset();
      // Stop timer
      if (otpTimer) {
        clearInterval(otpTimer);
      }
      // Reset timer display
      document.getElementById('resendTimer').textContent = '60';
      const resendBtn = document.querySelector('.otp-actions .btn:first-child');
      resendBtn.disabled = false;
      resendBtn.style.opacity = '1';
    }
    // Login OTP Timer functionality
    let loginOtpTimer;
    let loginOtpTimeLeft = 60;
    function startLoginOTPTimer() {
      loginOtpTimeLeft = 60;
      const timerDisplay = document.getElementById('loginResendTimer');
      const resendBtn = document.querySelector('.otp-actions .btn:first-child');
      resendBtn.disabled = true;
      resendBtn.style.opacity = '0.5';
      loginOtpTimer = setInterval(() => {
        loginOtpTimeLeft--;
        timerDisplay.textContent = loginOtpTimeLeft;
        if (loginOtpTimeLeft <= 0) {
          clearInterval(loginOtpTimer);
          resendBtn.disabled = false;
          resendBtn.style.opacity = '1';
          timerDisplay.textContent = '0';
        }
      }, 1000);
    }
    // Resend Login OTP function
    async function resendLoginOTP() {
      if (loginOtpTimeLeft > 0) return;
      
      const role = window.currentLoginRole || 'user';
      
      if (role === 'user' && window.loginData?.email) {
        try {
          const response = await fetch('/api/user/login/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: window.loginData.email,
              password: window.loginData.password
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification(data.message, 'success');
            startLoginOTPTimer();
          } else {
            showNotification(data.error || 'Failed to resend verification code', 'error');
          }
        } catch (error) {
          console.error('Resend login OTP error:', error);
          showNotification('Network error. Please try again.', 'error');
        }
      } else {
        // Admin resend - demo
        console.log('Admin login OTP resent to:', window.loginData?.email);
        showNotification('Verification code resent!', 'info');
        startLoginOTPTimer();
      }
    }
    // Change Login Email function
    function changeLoginEmail() {
      // Go back to login form
      document.getElementById('loginOtpForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
      // Show role toggle again
      document.querySelector('#loginModal .role-toggle').style.display = 'block';
      // Clear OTP form
      document.getElementById('loginOtpForm').reset();
      // Stop timer
      if (loginOtpTimer) {
        clearInterval(loginOtpTimer);
      }
      // Reset timer display
      document.getElementById('loginResendTimer').textContent = '60';
      const resendBtn = document.querySelector('.otp-actions .btn:first-child');
      resendBtn.disabled = false;
      resendBtn.style.opacity = '1';
    }
    // Role Toggle functionality
    function toggleRole(role, context) {
      window.currentLoginRole = role;
      if (context === 'login') {
        const loginSubmitBtn = document.getElementById('loginSubmitBtn') || document.querySelector('#loginForm button[type="submit"]');
        const adminNameField = document.getElementById('adminNameField');
        
        if (role === 'admin') {
          loginSubmitBtn.textContent = 'Proceed login';
          // Show admin name field
          if (adminNameField) {
            adminNameField.style.display = 'block';
            document.getElementById('adminLoginName').setAttribute('required', '');
          }
        } else {
          loginSubmitBtn.textContent = 'Send Verification Code';
          // Hide admin name field
          if (adminNameField) {
            adminNameField.style.display = 'none';
            document.getElementById('adminLoginName').removeAttribute('required');
          }
        }
      }
      // Update active state of toggle buttons
      const modal = document.getElementById(context + 'Modal');
      const toggleBtns = modal.querySelectorAll('.toggle-btn');
      toggleBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.role === role) {
          btn.classList.add('active');
        }
      });
      
      // Force update form visibility for signup modal
      if (context === 'signup') {
        const signupForm = document.getElementById('signupForm');
        const nameField = signupForm.querySelector('#signupName').closest('.form-group');
        if (role === 'admin') {
          nameField.style.display = 'none';
        } else {
          nameField.style.display = 'block';
        }
      }
      // Store the selected role for the current modal
      if (context === 'login') {
        window.currentLoginRole = role;
      } else {
        window.currentSignupRole = role;
      }
      // Update modal header to show selected role
      const header = modal.querySelector('.modal-header h2');
      if (context === 'login') {
        header.textContent = `Login as ${role.charAt(0).toUpperCase() + role.slice(1)}`;
      } else {
        header.textContent = `Sign Up as ${role.charAt(0).toUpperCase() + role.slice(1)}`;
      }
      // Handle Admin Sign-Up form field visibility
      if (context === 'signup') {
        const signupForm = document.getElementById('signupForm');
        const nameField = signupForm.querySelector('#signupName').closest('.form-group');
        const nameInput = signupForm.querySelector('#signupName');
        const systemActivationKeyField = signupForm.querySelector('#systemActivationKey')?.closest('.form-group');
        const adminAccessKeyField = signupForm.querySelector('#adminAccessKey')?.closest('.form-group');
        const adminMessage = signupForm.querySelector('#adminMessage');
        if (role === 'admin') {
          // Hide name field for admin
          nameField.style.display = 'none';
          if (nameInput) { nameInput.disabled = true; nameInput.removeAttribute('required'); }
          // Show system activation key field if it exists, or create it
          if (!systemActivationKeyField) {
            const confirmPasswordField = signupForm.querySelector('#signupConfirmPassword').closest('.form-group');
            const newSystemActivationKeyField = document.createElement('div');
            newSystemActivationKeyField.className = 'form-group';
            newSystemActivationKeyField.innerHTML = `
              <label for="systemActivationKey">System Activation Key</label>
              <input type="text" id="systemActivationKey" name="systemActivationKey" placeholder="Enter system key (e.g., F32024)" required>
            `;
            signupForm.insertBefore(newSystemActivationKeyField, confirmPasswordField.nextSibling);
          } else {
            systemActivationKeyField.style.display = 'block';
            const systemActivationInput = systemActivationKeyField.querySelector('#systemActivationKey');
            if (systemActivationInput) { 
              systemActivationInput.disabled = false; 
              systemActivationInput.setAttribute('required', ''); 
            }
          }
          // Show admin message if it exists, or create it (must appear directly above System Activation Key)
          if (!adminMessage) {
            const confirmPasswordField = signupForm.querySelector('#signupConfirmPassword').closest('.form-group');
            const newAdminMessage = document.createElement('div');
            newAdminMessage.className = 'form-group';
            newAdminMessage.id = 'adminMessage';
            newAdminMessage.innerHTML = `
              <p>Enter the System Activation Key from your administrator.</p>
            `;
            // Insert now; it will sit above the system key after we add the access key below
            signupForm.insertBefore(newAdminMessage, confirmPasswordField.nextSibling);
          } else {
            adminMessage.style.display = 'block';
            // Update the message content for existing admin message
            adminMessage.querySelector('p').innerHTML = 'Enter the System Activation Key from your administrator.';
            // Ensure the message is positioned directly above the System Activation Key
            if (systemActivationKeyField && adminMessage.nextSibling !== systemActivationKeyField) {
              signupForm.insertBefore(adminMessage, systemActivationKeyField);
            }
          }
          // Show admin access key field if it exists, or create it
          if (!adminAccessKeyField) {
            const confirmPasswordField = signupForm.querySelector('#signupConfirmPassword').closest('.form-group');
            const newAdminAccessKeyField = document.createElement('div');
            newAdminAccessKeyField.className = 'form-group';
            newAdminAccessKeyField.innerHTML = `
              <label for="adminAccessKey">6-digit Admin Access Key (2FM)</label>
              <input type="text" id="adminAccessKey" name="adminAccessKey" maxlength="6" placeholder="Enter 6-digit key" pattern="[0-9]{6}" inputmode="numeric" required>
              <small class="muted">For admin 2-step verification; keep it private.</small>
            `;
            // Inserting last ensures this field appears above the message and system key
            signupForm.insertBefore(newAdminAccessKeyField, confirmPasswordField.nextSibling);
          } else {
            adminAccessKeyField.style.display = 'block';
            const adminAccessInput = adminAccessKeyField.querySelector('#adminAccessKey');
            if (adminAccessInput) { adminAccessInput.disabled = false; adminAccessInput.setAttribute('required',''); }
          }
        } else {
          // Show name field for user
          nameField.style.display = 'block';
          if (nameInput) { nameInput.disabled = false; nameInput.setAttribute('required',''); }
          // Hide activation key fields and admin message for user
          if (systemActivationKeyField) {
            systemActivationKeyField.style.display = 'none';
            const systemActivationInput = systemActivationKeyField.querySelector('#systemActivationKey');
            if (systemActivationInput) { 
              systemActivationInput.disabled = true; 
              systemActivationInput.removeAttribute('required'); 
              systemActivationInput.value = ''; // Clear value
            }
          }
          if (adminAccessKeyField) {
            adminAccessKeyField.style.display = 'none';
            const adminAccessInput = adminAccessKeyField.querySelector('#adminAccessKey');
            if (adminAccessInput) { 
              adminAccessInput.disabled = true; 
              adminAccessInput.removeAttribute('required'); 
              adminAccessInput.value = ''; // Clear value
            }
          }
          if (adminMessage) {
            adminMessage.style.display = 'none';
          }
        }
      }
      console.log(`${context} role changed to:`, role);
      console.log('Current signup role:', window.currentSignupRole);
      console.log('Current login role:', window.currentLoginRole);
    }
    // Initialize default roles
    window.currentLoginRole = 'user';
    window.currentSignupRole = 'user';
    
    // Add event listeners for barangay validation when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const barangayInput = document.getElementById('signupBarangay');
      if (barangayInput) {
        let debounceTimer;
        
        // Real-time validation and autocomplete
        barangayInput.addEventListener('input', function() {
          const value = this.value.trim();
          
          // Clear existing dropdown after a short delay
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            const existingDropdown = this.parentNode.querySelector('.barangay-dropdown');
            if (existingDropdown && value.length < 2) {
              existingDropdown.remove();
            }
          }, 300);
          
          // Validate as user types
          if (value.length > 0) {
            validateBarangayField(this);
            
            // Show suggestions for partial matches
            if (value.length >= 2) {
              const suggestions = getBarangaySuggestions(value);
              createBarangayDropdown(this, suggestions);
            }
          } else {
            // Reset styling when empty
            this.style.borderColor = '';
            this.style.backgroundColor = '';
            const existingError = this.parentNode.querySelector('.barangay-error');
            if (existingError) {
              existingError.remove();
            }
          }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!barangayInput.contains(e.target) && !e.target.closest('.barangay-dropdown')) {
            const dropdown = barangayInput.parentNode.querySelector('.barangay-dropdown');
            if (dropdown) {
              dropdown.remove();
            }
          }
        });
        
        // Validate on blur (when user leaves the field)
        barangayInput.addEventListener('blur', function() {
          validateBarangayField(this);
        });
      }
    });
    
    // Barangay validation function
    function isValidDavaoCityBarangay(barangayName) {
      // Normalize the input (trim, lowercase for comparison)
      const normalizedInput = barangayName.trim().toLowerCase();
      
      if (!normalizedInput) return null;
      
      // Check if the barangay exists in our database (case-insensitive)
      const barangayKeys = Object.keys(davaoCityBarangays);
      
      // First try exact match
      let foundBarangay = barangayKeys.find(key => 
        key.toLowerCase() === normalizedInput
      );
      
      // If no exact match, try partial match (for user convenience)
      if (!foundBarangay) {
        foundBarangay = barangayKeys.find(key => 
          key.toLowerCase().includes(normalizedInput) || 
          normalizedInput.includes(key.toLowerCase())
        );
      }
      
      return foundBarangay || null;
    }
    
    // Function to get barangay suggestions based on input
    function getBarangaySuggestions(input) {
      if (!input || input.length < 2) return [];
      
      const normalizedInput = input.toLowerCase();
      const suggestions = [];
      
      Object.keys(davaoCityBarangays).forEach(barangay => {
        if (barangay.toLowerCase().includes(normalizedInput)) {
          suggestions.push(barangay);
        }
      });
      
      return suggestions.slice(0, 10); // Limit to 10 suggestions
    }
    
    // Function to create dropdown suggestions
    function createBarangayDropdown(inputElement, suggestions) {
      // Remove existing dropdown
      const existingDropdown = inputElement.parentNode.querySelector('.barangay-dropdown');
      if (existingDropdown) {
        existingDropdown.remove();
      }
      
      if (suggestions.length === 0) return;
      
      // Create dropdown container
      const dropdown = document.createElement('div');
      dropdown.className = 'barangay-dropdown';
      dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      `;
      
      // Add suggestions
      suggestions.forEach(barangay => {
        const suggestionItem = document.createElement('div');
        suggestionItem.style.cssText = `
          padding: 12px 16px;
          cursor: pointer;
          border-bottom: 1px solid #f0f0f0;
          transition: background-color 0.2s;
        `;
        suggestionItem.textContent = barangay;
        
        suggestionItem.addEventListener('mouseenter', () => {
          suggestionItem.style.backgroundColor = '#f5f5f5';
        });
        
        suggestionItem.addEventListener('mouseleave', () => {
          suggestionItem.style.backgroundColor = 'white';
        });
        
        suggestionItem.addEventListener('click', () => {
          inputElement.value = barangay;
          dropdown.remove();
          validateBarangayField(inputElement);
        });
        
        dropdown.appendChild(suggestionItem);
      });
      
      // Insert dropdown after input
      inputElement.parentNode.style.position = 'relative';
      inputElement.parentNode.appendChild(dropdown);
    }
    
    // Function to show all valid barangays in a modal
    function showBarangayList() {
      const barangayKeys = Object.keys(davaoCityBarangays);
      const district1 = barangayKeys.filter(key => davaoCityBarangays[key].district === 1);
      const district2 = barangayKeys.filter(key => davaoCityBarangays[key].district === 2);
      const district3 = barangayKeys.filter(key => davaoCityBarangays[key].district === 3);
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: var(--card);
        border-radius: 12px;
        padding: 24px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        border: var(--border);
        box-shadow: var(--shadow);
      `;
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0; color: var(--text);">Official Davao City Barangays (182 Total)</h3>
          <button onclick="this.closest('.barangay-modal').remove()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="margin-bottom: 20px;">
          <h4 style="color: var(--brand); margin-bottom: 10px;">District 1 - Poblacion (${district1.length} barangays)</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-bottom: 20px;">
            ${district1.map(barangay => `<div style="padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 12px; color: var(--text);">${barangay}</div>`).join('')}
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <h4 style="color: var(--brand); margin-bottom: 10px;">District 2 (${district2.length} barangays)</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-bottom: 20px;">
            ${district2.map(barangay => `<div style="padding: 8px; background: rgba(34, 211, 238, 0.1); border-radius: 6px; font-size: 12px; color: var(--text);">${barangay}</div>`).join('')}
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <h4 style="color: var(--brand); margin-bottom: 10px;">District 3 - Talomo (${district3.length} barangays)</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
            ${district3.map(barangay => `<div style="padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; font-size: 12px; color: var(--text);">${barangay}</div>`).join('')}
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button onclick="this.closest('.barangay-modal').remove()" style="background: var(--brand); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Close</button>
        </div>
      `;
      
      modal.className = 'barangay-modal';
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // Function to validate barangay field
    function validateBarangayField(inputElement) {
      const barangay = inputElement.value.trim();
      const isValid = isValidDavaoCityBarangay(barangay);
      
      // Remove existing validation messages
      const existingError = inputElement.parentNode.parentNode.querySelector('.barangay-error');
      if (existingError) {
        existingError.remove();
      }
      
      if (barangay && !isValid) {
        // Show error message below the input group
        const errorDiv = document.createElement('div');
        errorDiv.className = 'barangay-error';
        errorDiv.innerHTML = `
          ‚ö†Ô∏è The barangay "${barangay}" is not part of Davao City. Please select from the official 182 barangays of Davao City.
        `;
        // Append to the form-group container (parent of input-with-button)
        inputElement.parentNode.parentNode.appendChild(errorDiv);
        
        // Add error styling to input
        inputElement.style.borderColor = '#e74c3c';
        inputElement.style.backgroundColor = '#fdf2f2';
        inputElement.style.color = '#000000'; /* Keep black text even in error state */
        
        return false;
      } else if (isValid) {
        // Add success styling
        inputElement.style.borderColor = '#27ae60';
        inputElement.style.backgroundColor = '#f2fdf2';
        inputElement.style.color = '#000000'; /* Keep black text in success state */
      } else {
        // Reset styling
        inputElement.style.borderColor = '';
        inputElement.style.backgroundColor = '';
        inputElement.style.color = '#000000'; /* Keep black text in normal state */
      }
      
      return isValid;
    }

    // Official Davao City Barangay Database (182 barangays) with accurate coordinates
    const davaoCityBarangays = {
      // üü¢ 1st DISTRICT (54 Barangays) - POBLACION (40 barangays)
      'Poblacion 1-A': { lat: 7.0731, lng: 125.6128, district: 1, code: '1-A', name: 'Poblacion' },
      'Poblacion 2-A': { lat: 7.0735, lng: 125.6132, district: 1, code: '2-A', name: 'Poblacion' },
      'Poblacion 3-A': { lat: 7.0739, lng: 125.6136, district: 1, code: '3-A', name: 'Poblacion' },
      'Poblacion 4-A': { lat: 7.0743, lng: 125.6140, district: 1, code: '4-A', name: 'Poblacion' },
      'Poblacion 5-A': { lat: 7.0747, lng: 125.6144, district: 1, code: '5-A', name: 'Poblacion' },
      'Poblacion 6-A': { lat: 7.0751, lng: 125.6148, district: 1, code: '6-A', name: 'Poblacion' },
      'Poblacion 7-A': { lat: 7.0755, lng: 125.6152, district: 1, code: '7-A', name: 'Poblacion' },
      'Poblacion 8-A': { lat: 7.0759, lng: 125.6156, district: 1, code: '8-A', name: 'Poblacion' },
      'Poblacion 9-A': { lat: 7.0763, lng: 125.6160, district: 1, code: '9-A', name: 'Poblacion' },
      'Poblacion 10-A': { lat: 7.0767, lng: 125.6164, district: 1, code: '10-A', name: 'Poblacion' },
      'Poblacion 11-B': { lat: 7.0771, lng: 125.6168, district: 1, code: '11-B', name: 'Poblacion' },
      'Poblacion 12-B': { lat: 7.0775, lng: 125.6172, district: 1, code: '12-B', name: 'Poblacion' },
      'Poblacion 13-B': { lat: 7.0779, lng: 125.6176, district: 1, code: '13-B', name: 'Poblacion' },
      'Poblacion 14-B': { lat: 7.0783, lng: 125.6180, district: 1, code: '14-B', name: 'Poblacion' },
      'Poblacion 15-B': { lat: 7.0787, lng: 125.6184, district: 1, code: '15-B', name: 'Poblacion' },
      'Poblacion 16-B': { lat: 7.0791, lng: 125.6188, district: 1, code: '16-B', name: 'Poblacion' },
      'Poblacion 17-B': { lat: 7.0795, lng: 125.6192, district: 1, code: '17-B', name: 'Poblacion' },
      'Poblacion 18-B': { lat: 7.0799, lng: 125.6196, district: 1, code: '18-B', name: 'Poblacion' },
      'Poblacion 19-B': { lat: 7.0803, lng: 125.6200, district: 1, code: '19-B', name: 'Poblacion' },
      'Poblacion 20-B': { lat: 7.0807, lng: 125.6204, district: 1, code: '20-B', name: 'Poblacion' },
      'Poblacion 21-C': { lat: 7.0650, lng: 125.6120, district: 1, code: '21-C', name: 'Poblacion' },
      'Poblacion 22-C': { lat: 7.0654, lng: 125.6124, district: 1, code: '22-C', name: 'Poblacion' },
      'Poblacion 23-C': { lat: 7.0658, lng: 125.6128, district: 1, code: '23-C', name: 'Poblacion' },
      'Poblacion 24-C': { lat: 7.0662, lng: 125.6132, district: 1, code: '24-C', name: 'Poblacion' },
      'Poblacion 25-C': { lat: 7.0666, lng: 125.6136, district: 1, code: '25-C', name: 'Poblacion' },
      'Poblacion 26-C': { lat: 7.0670, lng: 125.6140, district: 1, code: '26-C', name: 'Poblacion' },
      'Poblacion 27-C': { lat: 7.0674, lng: 125.6144, district: 1, code: '27-C', name: 'Poblacion' },
      'Poblacion 28-C': { lat: 7.0678, lng: 125.6148, district: 1, code: '28-C', name: 'Poblacion' },
      'Poblacion 29-C': { lat: 7.0682, lng: 125.6152, district: 1, code: '29-C', name: 'Poblacion' },
      'Poblacion 30-C': { lat: 7.0686, lng: 125.6156, district: 1, code: '30-C', name: 'Poblacion' },
      'Poblacion 31-D': { lat: 7.0669, lng: 125.6139, district: 1, code: '31-D', name: 'Poblacion' },
      'Poblacion 32-D': { lat: 7.0671, lng: 125.6141, district: 1, code: '32-D', name: 'Poblacion' },
      'Poblacion 33-D': { lat: 7.0673, lng: 125.6143, district: 1, code: '33-D', name: 'Poblacion' },
      'Poblacion 34-D': { lat: 7.0675, lng: 125.6145, district: 1, code: '34-D', name: 'Poblacion' },
      'Poblacion 35-D': { lat: 7.0677, lng: 125.6147, district: 1, code: '35-D', name: 'Poblacion' },
      'Poblacion 36-D': { lat: 7.0679, lng: 125.6149, district: 1, code: '36-D', name: 'Poblacion' },
      'Poblacion 37-D': { lat: 7.0681, lng: 125.6151, district: 1, code: '37-D', name: 'Poblacion' },
      'Poblacion 38-D': { lat: 7.0683, lng: 125.6153, district: 1, code: '38-D', name: 'Poblacion' },
      'Poblacion 39-D': { lat: 7.0685, lng: 125.6155, district: 1, code: '39-D', name: 'Poblacion' },
      'Poblacion 40-D': { lat: 7.0687, lng: 125.6157, district: 1, code: '40-D', name: 'Poblacion' },
      
      // District 2 (Major Named Barangays)
      'Agdao': { lat: 7.1056, lng: 125.6139, district: 2, code: 'AGDAO' },
      'Aurora Quezon': { lat: 7.0850, lng: 125.6180, district: 2, code: 'AQ-2' },
      'Buhangin Proper': { lat: 7.1300, lng: 125.6400, district: 2, code: 'BUH-P' },
      'Indangan': { lat: 7.1320, lng: 125.6380, district: 2, code: 'IND' },
      'Obrero': { lat: 7.0900, lng: 125.6200, district: 2, code: 'OBR' },
      'Paciano Rizal': { lat: 7.0950, lng: 125.6250, district: 2, code: 'PR' },
      'Bankerohan': { lat: 7.0850, lng: 125.6150, district: 2, code: 'BNK' },
      'New Carmen': { lat: 7.0920, lng: 125.6180, district: 2, code: 'NC' },
      'Ula': { lat: 7.1100, lng: 125.6300, district: 2, code: 'ULA' },
      'Madapo': { lat: 7.1150, lng: 125.6350, district: 2, code: 'MDP' },
      'Bucana': { lat: 7.1200, lng: 125.6320, district: 2, code: 'BUC' },
      'Roxas': { lat: 7.0800, lng: 125.6200, district: 2, code: 'ROX' },
      'Tugbok': { lat: 7.1500, lng: 125.5500, district: 2, code: 'TUG' },
      'Bunawan Proper': { lat: 7.1000, lng: 125.5000, district: 2, code: 'BUN-P' },
      'Paquibato Proper': { lat: 7.2000, lng: 125.4000, district: 2, code: 'PAQ-P' },
      'Marilog Proper': { lat: 7.3000, lng: 125.3000, district: 2, code: 'MAR-P' },
      'Baguio District': { lat: 7.2500, lng: 125.3500, district: 2, code: 'BAG-D' },
      'Calinan Proper': { lat: 7.1889, lng: 125.4558, district: 2, code: 'CAL-P' },
      'Ma-a': { lat: 7.1050, lng: 125.6250, district: 2, code: 'MAA' },
      'Lanang': { lat: 7.0950, lng: 125.6350, district: 2, code: 'LAN' },
      'Sasa': { lat: 7.1400, lng: 125.6650, district: 2, code: 'SAS' },
      'Waan': { lat: 7.1500, lng: 125.6750, district: 2, code: 'WAN' },
      
      // District 3 (Talomo District)
      'Talomo Proper': { lat: 7.0506, lng: 125.5947, district: 3 },
      'Apokororo': { lat: 7.0450, lng: 125.5900, district: 3 },
      'Catalunan Grande': { lat: 7.0400, lng: 125.5850, district: 3 },
      'Catalunan Peque√±o': { lat: 7.0380, lng: 125.5830, district: 3 },
      'Dumoy': { lat: 7.0350, lng: 125.5800, district: 3 },
      'Kilate': { lat: 7.0320, lng: 125.5780, district: 3 },
      'Lizada': { lat: 7.0300, lng: 125.5760, district: 3 },
      'Magtuod': { lat: 7.0280, lng: 125.5740, district: 3 },
      'Matina Aplaya': { lat: 7.0250, lng: 125.5720, district: 3 },
      'Matina Crossing': { lat: 7.0230, lng: 125.5700, district: 3 },
      'Matina Pangi': { lat: 7.0200, lng: 125.5680, district: 3 },
      'Mudiang': { lat: 7.0180, lng: 125.5660, district: 3 },
      'Mulig': { lat: 7.0160, lng: 125.5640, district: 3 },
      'Tacunan': { lat: 7.0140, lng: 125.5620, district: 3 },
      'Wilfredo Aquino': { lat: 7.0120, lng: 125.5600, district: 3 },
      'Mintal': { lat: 7.0600, lng: 125.5400, district: 3 },
      'Tibungco': { lat: 7.0550, lng: 125.5350, district: 3 },
      'Daliao': { lat: 7.0500, lng: 125.5300, district: 3 },
      'Lamanan': { lat: 7.0450, lng: 125.5250, district: 3 },
      'Biao Escuela': { lat: 7.0400, lng: 125.5200, district: 3 },
      'Biao Joaquin': { lat: 7.0350, lng: 125.5150, district: 3 },
      'Sirawan': { lat: 7.0300, lng: 125.5100, district: 3 },
      'Toril Proper': { lat: 7.0169, lng: 125.5053, district: 3 },
      'Toril District': { lat: 7.0250, lng: 125.5050, district: 3 },
      
      // Additional Popular Barangays
      'Lanang': { lat: 7.0950, lng: 125.6350, district: 2 },
      'Ma-a': { lat: 7.1050, lng: 125.6250, district: 2 },
      'Matina Biao': { lat: 7.0300, lng: 125.5650, district: 3 },
      'Bangkas Heights': { lat: 7.0400, lng: 125.5750, district: 3 },
      'Communal': { lat: 7.0500, lng: 125.5850, district: 3 },
      'Crossing Bayabas': { lat: 7.0600, lng: 125.5950, district: 3 },
      'Dacudao': { lat: 7.0700, lng: 125.6050, district: 2 },
      'Ecoland': { lat: 7.0800, lng: 125.6150, district: 2 },
      'Leon Garcia': { lat: 7.0900, lng: 125.6250, district: 2 },
      'Maa': { lat: 7.1000, lng: 125.6350, district: 2 },
      'Malabog': { lat: 7.1100, lng: 125.6450, district: 2 },
      'Mandug': { lat: 7.1200, lng: 125.6550, district: 2 },
      'Matina Pangi': { lat: 7.0200, lng: 125.5680, district: 3 },
      'Sasa': { lat: 7.1400, lng: 125.6650, district: 2 },
      'Waan': { lat: 7.1500, lng: 125.6750, district: 2 },
      
      // More Barangays from Different Districts
      'Alambre': { lat: 7.0320, lng: 125.5820, district: 3 },
      'Angalan': { lat: 7.0340, lng: 125.5840, district: 3 },
      'Baliok': { lat: 7.0360, lng: 125.5860, district: 3 },
      'Bangkas Heights': { lat: 7.0380, lng: 125.5880, district: 3 },
      'Baracatan': { lat: 7.0400, lng: 125.5900, district: 3 },
      'Bato': { lat: 7.0420, lng: 125.5920, district: 3 },
      'Binugao': { lat: 7.0440, lng: 125.5940, district: 3 },
      'Buda': { lat: 7.0460, lng: 125.5960, district: 3 },
      'Cadalian': { lat: 7.0480, lng: 125.5980, district: 3 },
      'Carmen': { lat: 7.0500, lng: 125.6000, district: 3 },
      'Catitipan': { lat: 7.0520, lng: 125.6020, district: 3 },
      'Centro San Isidro': { lat: 7.0540, lng: 125.6040, district: 3 },
      'Colosas': { lat: 7.0560, lng: 125.6060, district: 3 },
      'Communal': { lat: 7.0580, lng: 125.6080, district: 3 },
      'Crossing Bayabas': { lat: 7.0600, lng: 125.6100, district: 3 },
      'Dacudao': { lat: 7.0620, lng: 125.6120, district: 3 },
      'Dalag': { lat: 7.0640, lng: 125.6140, district: 3 },
      'Damatulan': { lat: 7.0660, lng: 125.6160, district: 3 },
      'Darong': { lat: 7.0680, lng: 125.6180, district: 3 },
      'Datu Salumay': { lat: 7.0700, lng: 125.6200, district: 3 },
      'Eden': { lat: 7.0720, lng: 125.6220, district: 3 },
      'Fatima': { lat: 7.0740, lng: 125.6240, district: 3 },
      'Governor Paciano Rizal': { lat: 7.0760, lng: 125.6260, district: 3 },
      'Ilang': { lat: 7.0780, lng: 125.6280, district: 3 },
      'Inayawan': { lat: 7.0800, lng: 125.6300, district: 3 },
      'Kap. Tomas Monteverde Sr.': { lat: 7.0820, lng: 125.6320, district: 3 },
      'Lasang': { lat: 7.0840, lng: 125.6340, district: 3 },
      'Limpapa': { lat: 7.0860, lng: 125.6360, district: 3 },
      'Lubogan': { lat: 7.0880, lng: 125.6380, district: 3 },
      'Lumiad': { lat: 7.0900, lng: 125.6400, district: 3 },
      'Magsaysay': { lat: 7.0920, lng: 125.6420, district: 3 },
      'Mahayag': { lat: 7.0940, lng: 125.6440, district: 3 },
      'Malamba': { lat: 7.0960, lng: 125.6460, district: 3 },
      'Manambulan': { lat: 7.0980, lng: 125.6480, district: 3 },
      'Mandug': { lat: 7.1000, lng: 125.6500, district: 3 },
      'Manuel Guianga': { lat: 7.1020, lng: 125.6520, district: 3 },
      'Matina Biao': { lat: 7.1040, lng: 125.6540, district: 3 },
      'Matina Pangi': { lat: 7.1060, lng: 125.6560, district: 3 },
      'Megkawayan': { lat: 7.1080, lng: 125.6580, district: 3 },
      'Ogan': { lat: 7.1100, lng: 125.6600, district: 3 },
      'Pampanga': { lat: 7.1120, lng: 125.6620, district: 3 },
      'Pangyan': { lat: 7.1140, lng: 125.6640, district: 3 },
      'Paradise Embac': { lat: 7.1160, lng: 125.6660, district: 3 },
      'Riverside': { lat: 7.1180, lng: 125.6680, district: 3 },
      'Saloy': { lat: 7.1200, lng: 125.6700, district: 3 },
      'Santo Ni√±o': { lat: 7.1220, lng: 125.6720, district: 3 },
      'Subasta': { lat: 7.1240, lng: 125.6740, district: 3 },
      'Suawan': { lat: 7.1260, lng: 125.6760, district: 3 },
      'Sumimao': { lat: 7.1280, lng: 125.6780, district: 3 },
      'Tagluno': { lat: 7.1300, lng: 125.6800, district: 3 },
      'Tagurano': { lat: 7.1320, lng: 125.6820, district: 3 },
      'Tamayong': { lat: 7.1340, lng: 125.6840, district: 3 },
      'Tamugan': { lat: 7.1360, lng: 125.6860, district: 3 },
      'Tapak': { lat: 7.1380, lng: 125.6880, district: 3 },
      'Tigatto': { lat: 7.1400, lng: 125.6900, district: 3 },
      'Tuburan': { lat: 7.1420, lng: 125.6920, district: 3 },
      'Tungkalan': { lat: 7.1440, lng: 125.6940, district: 3 },
      'Vicente Hizon Sr.': { lat: 7.1460, lng: 125.6960, district: 3 },
      'Wangan': { lat: 7.1480, lng: 125.6980, district: 3 },
      
      // Additional Official Barangays with proper names and codes
      'Julio Paca√±a': { lat: 7.0920, lng: 125.6300, district: 2, code: 'JP-2' },
      'Rafael Castillo': { lat: 7.0940, lng: 125.6320, district: 2, code: 'RC-2' },
      'Wilfredo Aquino': { lat: 7.0120, lng: 125.5600, district: 3, code: 'WA-3' },
      'Leon Garcia Sr.': { lat: 7.0900, lng: 125.6250, district: 2, code: 'LGS-2' },
      'Manuel Guianga': { lat: 7.1020, lng: 125.6520, district: 3, code: 'MG-3' },
      'Tomas Monteverde Sr.': { lat: 7.0820, lng: 125.6320, district: 3, code: 'TMS-3' },
      'Vicente Hizon Sr.': { lat: 7.1460, lng: 125.6960, district: 3, code: 'VHS-3' },
      'Datu Salumay': { lat: 7.0700, lng: 125.6200, district: 3, code: 'DS-3' },
      'Paradise Embac': { lat: 7.1160, lng: 125.6660, district: 3, code: 'PE-3' },
      'Centro San Isidro': { lat: 7.0540, lng: 125.6040, district: 3, code: 'CSI-3' }
    };

    // Calculate distance between two coordinates using Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // Distance in kilometers
    }

    // Enhanced geolocation function for accurate Davao City barangay detection
    async function locateBarangay() {
      const barangayInput = document.getElementById('signupBarangay');
      const locateBtn = document.getElementById('locateBarangayBtn');
      const locateBtnText = document.getElementById('locateBtnText');
      
      if (!barangayInput || !locateBtn || !locateBtnText) {
        showNotification('Error: Could not find barangay input field', 'error');
        return;
      }
      
      // Check if geolocation is supported
      if (!navigator.geolocation) {
        showNotification('Geolocation is not supported by your browser', 'error');
        return;
      }
      
      // Update button state
      locateBtn.disabled = true;
      locateBtnText.textContent = 'üîç Detecting...';
      
      try {
        // Get current position with high accuracy and stricter settings
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 20000,        // Increased timeout for better accuracy
            maximumAge: 0          // Force fresh GPS reading, no cache
          });
        });
        
        const { latitude, longitude, accuracy } = position.coords;
        console.log('üìç GPS Location detected:', latitude, longitude);
        console.log('üéØ GPS Accuracy:', accuracy, 'meters');
        console.log('üìç Your location: Lat', latitude, 'Lng', longitude);
        
        // Validate if location is within Davao City bounds (more accurate bounds)
        const davaoCityBounds = {
          north: 7.3,    // More restrictive northern boundary
          south: 6.9,    // More restrictive southern boundary  
          east: 125.7,   // More restrictive eastern boundary
          west: 125.1    // More restrictive western boundary
        };
        
        if (latitude < davaoCityBounds.south || latitude > davaoCityBounds.north || 
            longitude < davaoCityBounds.west || longitude > davaoCityBounds.east) {
          console.log('‚ùå Location outside Davao City bounds:');
          console.log('üìç Your coordinates:', latitude, longitude);
          console.log('üèôÔ∏è Davao City bounds:', davaoCityBounds);
          throw new Error('Location appears to be outside Davao City. Please select your barangay manually.');
        }
        
        // Find closest barangay using accurate distance calculation
        let closestBarangay = 'Unknown';
        let minDistance = Infinity;
        let foundDistrict = null;
        
        for (const [name, coords] of Object.entries(davaoCityBarangays)) {
          const distance = calculateDistance(latitude, longitude, coords.lat, coords.lng);
          
          if (distance < minDistance) {
            minDistance = distance;
            closestBarangay = name;
            foundDistrict = coords.district;
          }
        }
        
        // Format the result according to your desired format
        const barangayData = davaoCityBarangays[closestBarangay];
        let formattedName = closestBarangay;
        
        // The barangay names are now already in the correct format
        // No additional formatting needed since database uses "Poblacion 36-D" format
        formattedName = closestBarangay;
        
        // Set the detected barangay
        barangayInput.value = formattedName;
        
        // Show detailed success notification
        const distanceKm = minDistance.toFixed(2);
        showNotification(`üìç Location detected: ${formattedName} (District ${foundDistrict}) - ${distanceKm}km accuracy`, 'success');
        
        // Update button state
        locateBtnText.textContent = '‚úÖ Located';
        setTimeout(() => {
          locateBtnText.textContent = 'üìç Locate';
          locateBtn.disabled = false;
        }, 3000);
        
      } catch (error) {
        console.error('Geolocation error:', error);
        
        let errorMessage = 'Failed to detect your location';
        
        if (error.code === 1) {
          errorMessage = 'Location access denied. Please allow location access in your browser settings.';
        } else if (error.code === 2) {
          errorMessage = 'Location unavailable. Please check your device location settings.';
        } else if (error.code === 3) {
          errorMessage = 'Location request timed out. Please try again.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showNotification(errorMessage, 'error');
        
        // Reset button state
        locateBtnText.textContent = 'üìç Locate';
        locateBtn.disabled = false;
      }
    }
    // Check URL parameters on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize form states to default (User)
      window.currentLoginRole = 'user';
      window.currentSignupRole = 'user';
      
      // Ensure signup form starts with correct field visibility
      setTimeout(() => {
        toggleRole('user', 'signup');
      }, 100);
      
      const urlParams = new URLSearchParams(window.location.search);
      const showLogin = urlParams.get('show_login');
      
      if (showLogin === 'true') {
        // Show login modal automatically
        setTimeout(() => {
          openModal('loginModal');
          // Show a notification that authentication is required
          showNotification('Authentication required to access admin pages', 'info');
        }, 500);
      }
    });
    
    // Password toggle functionality
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const toggle = input.parentElement.querySelector('.password-toggle');
      const eyeIcon = toggle.querySelector('.eye-icon');
      
      if (input.type === 'password') {
        input.type = 'text';
        eyeIcon.textContent = 'Hide';
        toggle.classList.add('active');
      } else {
        input.type = 'password';
        eyeIcon.textContent = 'Show';
        toggle.classList.remove('active');
      }
    }
  </script>
</body>
</html>

